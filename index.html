<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ß–µ–∫-–ª–∏—Å—Ç ‚Äî –õ–∏–Ω–∏–∏ –∏ –ö–ù–°</title>
  <meta name="theme-color" content="#0b2740">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b2740;
      --secondary: #123b63;
      --accent: #00b0ff;
      --bg-main: #eef2f8;
      --card-bg: #ffffff;
      --muted: #5a6a7e;
      --success: #10b981;
      --warning: #f59e0b;
      --progress-bg: #dde4ee;
      --glass-bg: rgba(255,255,255,0.92);
      --border: #dde4ee;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Source Sans 3', sans-serif;
      background: var(--bg-main);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(0,176,255,0.07) 0%, transparent 55%),
        radial-gradient(ellipse at 80% 100%, rgba(11,39,64,0.07) 0%, transparent 55%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #1a2a3a;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: linear-gradient(90deg, #0b2740 0%, #0e3359 60%, #123b63 100%);
      padding: 0;
      box-shadow: 0 4px 24px rgba(11,39,64,0.45);
      position: sticky; top: 0; z-index: 100;
      border-bottom: 2px solid rgba(0,176,255,0.3);
    }
    .header-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header .logo-text {
      font-family: 'Oswald', sans-serif;
      font-size: 1.25em;
      font-weight: 600;
      color: #fff;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    header img {
      height: 36px;
      width: auto;
      max-width: 160px;
      object-fit: contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
    }
    .header-title {
      font-family: 'Oswald', sans-serif;
      font-size: 0.75em;
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      border-left: 1px solid rgba(255,255,255,0.2);
      padding-left: 16px;
    }

    /* ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ */
    .container {
      max-width: 960px;
      margin: 0 auto 40px auto;
      padding: 24px 20px;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      color: var(--primary);
      margin: 0 0 24px 0;
      font-size: 1.9em;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-align: center;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ INTRO ‚îÄ‚îÄ */
    .intro {
      background: var(--glass-bg);
      padding: 18px 22px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(11,39,64,0.08);
    }
    .intro-field {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .intro-field label {
      font-family: 'Oswald', sans-serif;
      font-size: 0.78em;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 500;
      white-space: nowrap;
    }
    .intro input[type="date"],
    .intro input[type="text"] {
      padding: 7px 11px;
      border: 1px solid var(--border);
      border-radius: 7px;
      font-size: 14px;
      font-family: 'Source Sans 3', sans-serif;
      background: #f8fafc;
      color: #1a2a3a;
      transition: border-color 0.2s;
    }
    .intro input:focus { outline: none; border-color: var(--accent); background: #fff; }
    .intro input::placeholder { color: #a0b0c0; }
    #workDate { width: 160px; }
    #workerName { width: 180px; }
    .intro-hint {
      font-size: 12px;
      color: var(--muted);
      width: 100%;
      margin: 0;
      padding-top: 4px;
      border-top: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ TASK GROUP (checklist blocks) ‚îÄ‚îÄ */
    .task-group {
      margin-bottom: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .task-group:hover {
      box-shadow: 0 8px 28px rgba(11,39,64,0.12);
      border-color: rgba(0,176,255,0.35);
    }
    .group-header {
      padding: 16px 20px 14px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: background 0.2s;
    }
    .group-header:hover { background: #f7fafd; }
    .group-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .task-group h2 {
      font-family: 'Oswald', sans-serif;
      color: var(--primary);
      margin: 0;
      font-size: 1.05em;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .task-group h2 .icon { font-size: 1.1em; line-height: 1; }
    .group-chevron {
      color: var(--muted);
      font-size: 18px;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }
    .task-group.open .group-chevron { transform: rotate(180deg); }
    .progress-container {
      height: 4px;
      background: var(--progress-bg);
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, #34d399 100%);
      width: 0%;
      transition: width 0.4s ease;
      border-radius: 999px;
      box-shadow: 0 0 8px rgba(0,176,255,0.5);
    }
    .subtasks {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-group.open .subtasks { max-height: 4000px; }
    .subtasks-inner {
      padding: 6px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .subtask {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      background: #f8fafc;
      border-radius: 9px;
      border-left: 3px solid transparent;
      cursor: pointer;
      transition: all 0.18s ease;
      gap: 12px;
    }
    .subtask:hover { background: #f0f6ff; border-left-color: var(--accent); }
    .subtask.completed { background: #f0fdf8; border-left-color: var(--success); }
    .subtask input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: var(--accent);
      cursor: pointer; flex-shrink: 0;
    }
    .subtask span {
      font-size: 14px; color: #2a3a4a;
      flex: 1; line-height: 1.4; font-weight: 400;
    }
    .subtask.completed span { text-decoration: line-through; color: #94a3b8; }

    /* ‚îÄ‚îÄ TABLE BLOCK ‚îÄ‚îÄ */
    .table-group {
      margin-bottom: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .table-group:hover {
      box-shadow: 0 8px 28px rgba(11,39,64,0.12);
      border-color: rgba(0,176,255,0.35);
    }
    .table-group-header {
      padding: 16px 20px 14px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: background 0.2s;
    }
    .table-group-header:hover { background: #f7fafd; }
    .table-group h2 {
      font-family: 'Oswald', sans-serif;
      color: var(--primary);
      margin: 0;
      font-size: 1.05em;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .table-group.open .group-chevron { transform: rotate(180deg); }

    .table-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .table-group.open .table-body { max-height: 4000px; }

    .table-inner {
      padding: 0 16px 16px;
    }

    /* Tabs for lines */
    .line-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .line-tab {
      font-family: 'Oswald', sans-serif;
      font-size: 0.8em;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 600;
      padding: 7px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.18s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .line-tab:hover { background: #f0f6ff; border-color: var(--accent); color: var(--primary); }
    .line-tab.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 4px 14px rgba(11,39,64,0.3);
    }
    .line-tab .tab-badge {
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 0.85em;
      min-width: 24px;
      text-align: center;
    }
    .line-tab:not(.active) .tab-badge {
      background: rgba(0,176,255,0.12);
      color: var(--accent);
    }

    /* Search bar inside table block */
    .table-search {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    .table-search input {
      flex: 1;
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Source Sans 3', sans-serif;
      background: #f8fafc;
      color: #1a2a3a;
      transition: border-color 0.2s;
    }
    .table-search input:focus { outline: none; border-color: var(--accent); background: #fff; }
    .table-search input::placeholder { color: #a0b0c0; }

    .refresh-btn {
      font-family: 'Oswald', sans-serif;
      font-size: 0.8em;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--primary);
      cursor: pointer;
      transition: all 0.18s ease;
      white-space: nowrap;
    }
    .refresh-btn:hover { background: #f0f6ff; border-color: var(--accent); }
    .refresh-btn:disabled { opacity: 0.5; cursor: default; }

    /* Status box */
    .status-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #f0fdf8;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      font-size: 13px;
      color: #065f46;
      margin-bottom: 12px;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--success);
      flex-shrink: 0;
    }

    /* Table styles */
    .data-table-wrap {
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: auto;
      max-height: 420px;
    }
    .data-table {
      min-width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .data-table thead th {
      position: sticky;
      top: 0;
      background: #f0f4f9;
      padding: 10px 14px;
      text-align: left;
      font-family: 'Oswald', sans-serif;
      font-size: 0.78em;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
      white-space: nowrap;
      border-bottom: 2px solid var(--border);
      z-index: 10;
    }
    .data-table tbody td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      color: #2a3a4a;
    }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .data-table tbody tr { transition: background 0.15s; }
    .data-table tbody tr:hover { background: #f7fafd; }
    .data-table tbody tr.row-done { background: #f0fdf8; }
    .data-table tbody tr.row-done td { color: #6b7280; }
    .data-table tbody tr.row-wait { background: #fff8ed; }

    .table-loading {
      text-align: center;
      padding: 32px;
      color: var(--muted);
      font-size: 14px;
    }
    .table-empty {
      text-align: center;
      padding: 24px;
      color: var(--muted);
      font-size: 14px;
    }
    .table-error {
      text-align: center;
      padding: 24px;
      color: #e11d48;
      font-size: 14px;
    }

    /* table count */
    .count-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(0,176,255,0.1);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 12px;
      color: var(--accent);
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
    .count-chip.done { background: rgba(16,185,129,0.12); color: var(--success); }

    /* ‚îÄ‚îÄ TAG EVENTS ‚îÄ‚îÄ */
    .tag-events {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }
    @media (max-width: 540px) {
      .tag-events { grid-template-columns: 1fr; }
    }
    .tag-event-block {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tag-event-new { border-left: 3px solid var(--success); }
    .tag-event-lost { border-left: 3px solid #f87171; }

    .tag-event-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tag-event-icon {
      font-size: 15px;
      font-weight: 700;
      width: 24px; height: 24px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      font-family: 'Oswald', sans-serif;
    }
    .tag-event-new .tag-event-icon { background: rgba(16,185,129,0.15); color: var(--success); }
    .tag-event-lost .tag-event-icon { background: rgba(248,113,113,0.15); color: #e11d48; }

    .tag-event-title {
      font-family: 'Oswald', sans-serif;
      font-size: 0.82em;
      font-weight: 600;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--primary);
      flex: 1;
    }
    .tag-event-counter {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag-event-counter span {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: 1.15em;
      min-width: 24px;
      text-align: center;
      color: var(--primary);
    }
    .counter-btn {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--primary);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      line-height: 1;
      padding: 0;
    }
    .counter-btn:hover { background: #f0f6ff; border-color: var(--accent); }

    .tag-event-notes {
      width: 100%;
      min-height: 56px;
      resize: vertical;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 7px;
      font-size: 13px;
      font-family: 'Source Sans 3', sans-serif;
      background: #fff;
      color: #1a2a3a;
      transition: border-color 0.2s;
      line-height: 1.4;
    }
    .tag-event-notes:focus { outline: none; border-color: var(--accent); }
    .tag-event-notes::placeholder { color: #a0b0c0; }

    /* ‚îÄ‚îÄ REPORT SECTION ‚îÄ‚îÄ */
    .report-section {
      margin-top: 8px;
      background: var(--glass-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(11,39,64,0.07);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .report-line-info {
      font-size: 14px;
      color: var(--muted);
      flex: 1;
      min-width: 180px;
    }
    .report-line-info strong {
      color: var(--primary);
      font-weight: 600;
    }
    .report-line-info .pct {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5em;
      font-weight: 700;
      color: var(--accent);
      margin-right: 6px;
    }
    .report-line-info .pct.pct-done { color: var(--success); }
    .btn-report {
      font-family: 'Oswald', sans-serif;
      font-size: 0.95em;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
      padding: 11px 28px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #04111f;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      box-shadow: 0 4px 14px rgba(0,176,255,0.3);
    }
    .btn-report:hover:not(:disabled) {
      background: #19b9ff;
      box-shadow: 0 6px 20px rgba(0,176,255,0.45);
      transform: translateY(-1px);
    }
    .btn-report:disabled {
      background: var(--progress-bg);
      color: var(--muted);
      box-shadow: none;
      cursor: default;
    }

    /* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
    #confetti { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000; }

    @media (max-width: 500px) {
      h1 { font-size: 1.4em; }
      .actions { flex-wrap: wrap; gap: 8px; justify-content: center; padding: 12px 14px; }
      .btn { flex: 1; min-width: 120px; justify-content: center; }
      #totalProgress { order: -1; width: 100%; font-size: 22px; }
    }
    @supports (padding: max(0px)) {
      .actions { bottom: max(16px, env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <img src="./images/ITS_logo_horizont.png" alt="ITSSupport"
           onerror="this.style.display='none'">
      <span class="logo-text" id="logoFallback" style="display:none">ITSSupport</span>
      <span class="header-title">–ß–µ–∫-–ª–∏—Å—Ç —Å–º–µ–Ω—ã</span>
    </div>
  </header>

  <div class="container">
    <!-- INTRO -->
    <div class="intro">
      <div class="intro-field">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="workDate">
      </div>
      <div class="intro-field">
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <input type="text" id="workerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
      </div>
      <p class="intro-hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á–∏ ¬∑ –û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∫–ª–∏–∫–æ–º</p>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ß–ï–ö–õ–ò–°–¢ –ë–õ–û–ö–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- –£–¢–†–û -->
    <div class="task-group" data-group="morning">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon">üïï</span> –£—Ç—Ä–æ (6:00‚Äì8:00)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="morning"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-1">
          <span>–§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–º–µ–Ω—ã</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-2">
          <span>–í—ã–¥–∞—á–∞ —á–∞—Å–æ–≤ –≤ –æ–∫–Ω–µ 6:00‚Äì8:00. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–æ–∫ —Å —á–∞—Å–∞–º–∏</span>
        </div>
      </div></div>
    </div>

    <!-- –ü–û–î–ì–û–¢–û–í–ö–ê -->
    <div class="task-group" data-group="prep">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon">‚öôÔ∏è</span> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±—Ö–æ–¥—É</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="prep"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="prep-1">
          <span>–ó–∞–ø—É—Å–∫ —Å–º–µ–Ω—ã –Ω–∞ —á–∞—Å–∞—Ö, –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="prep-2">
          <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="prep-3">
          <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—é–∫–∑–∞–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º</span>
        </div>
      </div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ë–õ–û–ö –¢–ê–ë–õ–ò–¶: –õ–ò–ù–ò–ò –ò –ö–ù–° ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="table-group" data-tgroup="lines">
      <div class="table-group-header">
        <div class="group-title-row">
          <h2><span class="icon">üì°</span> –û–±—Ö–æ–¥ –ø–æ –º–µ—Ç–∫–∞–º</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="linesProgressBar"></div>
        </div>
      </div>
      <div class="table-body">
        <div class="table-inner">

          <!-- Tabs -->
          <div class="line-tabs">
            <button class="line-tab active" data-line="1">
              –õ–∏–Ω–∏—è 1 <span class="tab-badge" id="badge1">‚Äî</span>
            </button>
            <button class="line-tab" data-line="2">
              –õ–∏–Ω–∏—è 3 <span class="tab-badge" id="badge2">‚Äî</span>
            </button>
            <button class="line-tab" data-line="kns">
              –ö–ù–° <span class="tab-badge" id="badgeKns">‚Äî</span>
            </button>
          </div>

          <!-- Status box -->
          <div class="status-box" id="statusBox" style="display:none">
            <div class="status-dot"></div>
            <span id="statusText"></span>
          </div>

          <!-- Search -->
          <div class="table-search">
            <input type="number" inputmode="numeric" id="tableSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ –º–µ—Ç–∫–∏...">
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">‚Ü∫ –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <!-- Table output -->
          <div class="data-table-wrap">
            <table class="data-table">
              <thead id="dataThead"></thead>
              <tbody id="dataTbody">
                <tr><td class="table-loading" colspan="99">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Summary chips -->
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
            <span class="count-chip" id="chipTotal">–í—Å–µ–≥–æ: ‚Äî</span>
            <span class="count-chip done" id="chipDone">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ‚Äî</span>
          </div>

          <!-- –ù–æ–≤—ã–µ –∏ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ -->
          <div class="tag-events">

            <div class="tag-event-block tag-event-new">
              <div class="tag-event-header">
                <span class="tag-event-icon">Ôºã</span>
                <span class="tag-event-title">–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏</span>
                <div class="tag-event-counter">
                  <button class="counter-btn" onclick="changeCount('new', -1)">‚àí</button>
                  <span id="countNew">0</span>
                  <button class="counter-btn" onclick="changeCount('new', 1)">Ôºã</button>
                </div>
              </div>
              <textarea id="notesNew" class="tag-event-notes" placeholder="–ù–æ–º–µ—Ä–∞ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 101, 205, 318..."></textarea>
            </div>

            <div class="tag-event-block tag-event-lost">
              <div class="tag-event-header">
                <span class="tag-event-icon">‚àí</span>
                <span class="tag-event-title">–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –º–µ—Ç–∫–∏</span>
                <div class="tag-event-counter">
                  <button class="counter-btn" onclick="changeCount('lost', -1)">‚àí</button>
                  <span id="countLost">0</span>
                  <button class="counter-btn" onclick="changeCount('lost', 1)">Ôºã</button>
                </div>
              </div>
              <textarea id="notesLost" class="tag-event-notes" placeholder="–ù–æ–º–µ—Ä–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 42, 77..."></textarea>
            </div>

          </div>

        </div>
      </div>
    </div>

    <!-- –í–ï–ß–ï–† -->
    <div class="task-group" data-group="evening">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon">üåô</span> –í–µ—á–µ—Ä (18:00‚Äì19:30)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="evening"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="evening-1">
          <span>–°–±–æ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏–π, —Ñ–∏–∫—Å–∞—Ü–∏—è –≤ –∂—É—Ä–Ω–∞–ª–µ</span>
        </div>
        <div class="subtask">
          <input type="checkbox" data-task-id="evening-2">
          <span>–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞</span>
        </div>
      </div></div>
    </div>

    <!-- –û–¢–ß–Å–¢ -->
    <div class="report-section">
      <div class="report-line-info" id="reportLineInfo">
        –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –≤ –±–ª–æ–∫–µ ¬´–û–±—Ö–æ–¥ –ø–æ –º–µ—Ç–∫–∞–º¬ª –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞
      </div>
      <button class="btn btn-report" id="reportBtn" onclick="exportReport()" disabled>
        ‚Üó –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç
      </button>
    </div>

  </div><!-- /container -->

  <canvas id="confetti"></canvas>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  GOOGLE SHEETS CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SHEET_ID = "1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c";
    const SHEET_NAME = "–î–ª—è –ø–µ—á–∞—Ç–∏üñ®Ô∏è";
    const STATUS_SHEET_NAME = "–°–≤–æ–¥_–∂—É—Ä–Ω–∞–ª–æ–≤_–°–ü–ì+–¢–°–ë";
    const STATUS_RANGE = "Q1:R2";

    const GROUPS = {
      "1":   "D2:M200",
      "2":   "R2:Z200",
      "kns": "AD2:AM200"
    };

    const TRIGGER_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzU7wYhYZxJu8_QvJMq174aPZ6lPeHu5PY6jqfyGbE1QgxZv0KwFVvgsDt_A2-wXUWA/exec";
    const TRIGGER_TOKEN = "12345";
    const STATUS_COL_NAME = "–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞";
    const STATUS_WAIT = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö";
    const STATUS_DONE = "–î–∞–Ω–Ω—ã–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã";

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CHECKLIST STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const STORAGE_KEY = 'itssupport_cl2_v1';

    function saveState() {
      const state = {
        tasks: Array.from(document.querySelectorAll('input[type="checkbox"]'))
          .map(cb => ({ id: cb.dataset.taskId, checked: cb.checked })),
        date: document.getElementById('workDate').value,
        name: document.getElementById('workerName').value,
        groups: Array.from(document.querySelectorAll('.task-group'))
          .map(g => ({ id: g.dataset.group, open: g.classList.contains('open') })),
        tableOpen: document.querySelector('[data-tgroup="lines"]').classList.contains('open'),
        currentLine: currentLine,
        countNew: document.getElementById('countNew').textContent,
        countLost: document.getElementById('countLost').textContent,
        notesNew: document.getElementById('notesNew').value,
        notesLost: document.getElementById('notesLost').value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved) {
          saved.tasks?.forEach(({ id, checked }) => {
            const cb = document.querySelector(`[data-task-id="${id}"]`);
            if (cb) { cb.checked = checked; cb.closest('.subtask').classList.toggle('completed', checked); }
          });
          if (saved.date) document.getElementById('workDate').value = saved.date;
          if (saved.name) document.getElementById('workerName').value = saved.name;
          saved.groups?.forEach(({ id, open }) => {
            const group = document.querySelector(`[data-group="${id}"]`);
            if (group && open) group.classList.add('open');
          });
          if (saved.tableOpen) document.querySelector('[data-tgroup="lines"]').classList.add('open');
          if (saved.currentLine) currentLine = saved.currentLine;
          if (saved.countNew) document.getElementById('countNew').textContent = saved.countNew;
          if (saved.countLost) document.getElementById('countLost').textContent = saved.countLost;
          if (saved.notesNew) document.getElementById('notesNew').value = saved.notesNew;
          if (saved.notesLost) document.getElementById('notesLost').value = saved.notesLost;
        }
      } catch (e) {}
      updateAllProgress();
    }

    function updateGroupProgress(groupId) {
      const group = document.querySelector(`[data-group="${groupId}"]`);
      const tasks = group.querySelectorAll('input[type="checkbox"]');
      const checked = group.querySelectorAll('input[type="checkbox"]:checked').length;
      const percent = tasks.length ? Math.round((checked / tasks.length) * 100) : 0;
      group.querySelector('.progress-bar').style.width = percent + '%';
      return { checked, total: tasks.length };
    }

    function updateAllProgress() {
      document.querySelectorAll('.task-group').forEach(group => {
        updateGroupProgress(group.dataset.group);
      });
      // No global % bar anymore ‚Äî report section handles line progress
    }

    function changeCount(type, delta) {
      const el = document.getElementById(type === 'new' ? 'countNew' : 'countLost');
      const current = parseInt(el.textContent) || 0;
      el.textContent = Math.max(0, current + delta);
      saveState();
    }
      const info = labelCounts[currentLine];
      const infoEl = document.getElementById("reportLineInfo");
      const btn = document.getElementById("reportBtn");

      if (!info || info.total === 0) {
        infoEl.innerHTML = `–û—Ç–∫—Ä–æ–π—Ç–µ –±–ª–æ–∫ ¬´–û–±—Ö–æ–¥ –ø–æ –º–µ—Ç–∫–∞–º¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç`;
        btn.disabled = true;
        return;
      }

      const pct = Math.round((info.done / info.total) * 100);
      const lineLabel = currentLine === "kns" ? "–ö–ù–°" : currentLine === "2" ? "–õ–∏–Ω–∏—è 3" : `–õ–∏–Ω–∏—è ${currentLine}`;
      const isDone = pct === 100;

      infoEl.innerHTML = `<span class="pct ${isDone ? 'pct-done' : ''}">${pct}%</span> <strong>${lineLabel}</strong> ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${info.done} –∏–∑ ${info.total} –º–µ—Ç–æ–∫`;
      btn.disabled = false;
    }

    function resetAll() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —á–µ–∫-–ª–∏—Å—Ç?')) return;
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.closest('.subtask').classList.remove('completed');
      });
      updateAllProgress();
      saveState();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABLE / LINES STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentLine = "1";
    let lineData = { "1": null, "2": null, "kns": null };
    let labelCounts = {
      "1":   { total: 0, done: 0 },
      "2":   { total: 0, done: 0 },
      "kns": { total: 0, done: 0 }
    };

    function norm(s) { return String(s ?? "").toLowerCase().replace(/\s/g, ""); }
    function cellText(v) { return (v === null || v === undefined) ? "" : String(v); }
    function isIntLike(s) { return /^[0-9]+$/.test(String(s).trim()); }
    function esc(str) {
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
    }

    function updateBadges() {
      ["1","2","kns"].forEach(k => {
        const id = k === "kns" ? "badgeKns" : "badge" + k;
        const el = document.getElementById(id);
        const info = labelCounts[k];
        el.textContent = info.total > 0 ? `${info.done}/${info.total}` : "‚Äî";
      });
      // update lines progress bar
      let total = 0, done = 0;
      Object.values(labelCounts).forEach(v => { total += v.total; done += v.done; });
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;
      document.getElementById("linesProgressBar").style.width = pct + '%';
    }

    async function loadLine(lineKey, force = false) {
      if (lineData[lineKey] && !force) {
        renderLine(lineKey);
        return;
      }
      setTableContent(`<tr><td class="table-loading" colspan="99">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>`);
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&range=${encodeURIComponent(GROUPS[lineKey])}&headers=1&t=${Date.now()}`;
      try {
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const table = json.table;
        const headers = table.cols.map(c => cellText(c.label || ""));
        let rows = table.rows
          .map(r => (r.c || []).map(c => cellText(c ? c.v : "")))
          .filter(row => row.some(c => c.trim() !== ""));

        const labelIdx = headers.findIndex(h => norm(h).includes("–º–µ—Ç–∫"));
        const statusIdx = headers.findIndex(h => norm(h) === norm(STATUS_COL_NAME));

        // Sort: wait first, done last
        if (statusIdx !== -1) {
          rows.sort((a, b) => {
            const rank = v => {
              const s = v.trim();
              if (s === STATUS_WAIT) return 0;
              if (s === STATUS_DONE) return 1;
              return 2;
            };
            return rank(a[statusIdx]) - rank(b[statusIdx]);
          });
        }

        labelCounts[lineKey] = {
          total: rows.filter(r => labelIdx !== -1 && isIntLike(r[labelIdx])).length,
          done: rows.filter(r => statusIdx !== -1 && r[statusIdx].trim() === STATUS_DONE).length
        };

        lineData[lineKey] = { headers, rows, labelIdx, statusIdx };
      updateBadges();
        updateReportSection();
        renderLine(lineKey);
      } catch(e) {
        setTableContent(`<tr><td class="table-error" colspan="99">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>`);
      }
    }

    function renderLine(lineKey) {
      const data = lineData[lineKey];
      if (!data) return;
      const { headers, rows, labelIdx, statusIdx } = data;
      const q = document.getElementById("tableSearch").value.trim().toLowerCase();
      const filtered = rows.filter(r => !q || (labelIdx !== -1 && r[labelIdx].toLowerCase().includes(q)));

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º 4 –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
      const colMatchers = [
        { label: '‚Ññ –º–µ—Ç–∫–∏',          match: h => norm(h).includes('–º–µ—Ç–∫') },
        { label: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–æ–Ω—ã –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–∏–ø–∞', match: h => norm(h).includes('–Ω–∞–∏–º') && (norm(h).includes('–∑–æ–Ω') || norm(h).includes('—Ç–∏–ø')) },
        { label: '–û–ø–∏—Å–∞–Ω–∏–µ',          match: h => norm(h).includes('–æ–ø–∏—Å') },
        { label: '–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞',     match: h => norm(h) === norm(STATUS_COL_NAME) || norm(h).includes('—Å—Ç–∞—Ç') },
      ];

      const colIdxs = colMatchers.map(m => {
        const idx = headers.findIndex(m.match);
        return { label: m.label, idx };
      }).filter(c => c.idx !== -1);

      // Fallback: –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
      const displayCols = colIdxs.length >= 2 ? colIdxs : headers.map((h, i) => ({ label: h || '‚Äî', idx: i }));
      const colCount = displayCols.length;

      // Thead
      document.getElementById("dataThead").innerHTML =
        `<tr>${displayCols.map(c => `<th>${esc(c.label)}</th>`).join('')}</tr>`;

      if (filtered.length === 0) {
        setTableContent(`<tr><td class="table-empty" colspan="${colCount}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`);
      } else {
        document.getElementById("dataTbody").innerHTML = filtered.map(row => {
          const isDone = statusIdx !== -1 && row[statusIdx].trim() === STATUS_DONE;
          const isWait = statusIdx !== -1 && row[statusIdx].trim() === STATUS_WAIT;
          const cls = isDone ? 'row-done' : (isWait ? 'row-wait' : '');
          return `<tr class="${cls}">${displayCols.map(c => `<td>${esc(row[c.idx] ?? '')}</td>`).join('')}</tr>`;
        }).join('');
      }

      // Chips
      const info = labelCounts[lineKey];
      document.getElementById("chipTotal").textContent = `–í—Å–µ–≥–æ: ${info.total}`;
      document.getElementById("chipDone").textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${info.done}`;
    }

    function setTableContent(html) {
      document.getElementById("dataTbody").innerHTML = html;
      document.getElementById("dataThead").innerHTML = "";
    }

    async function loadStatusBox() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(STATUS_SHEET_NAME)}&range=${encodeURIComponent(STATUS_RANGE)}&headers=0&t=${Date.now()}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const lines = json.table.rows.map(r => r.c.map(c => cellText(c?.v)).filter(Boolean).join(" ")).filter(Boolean);
        const box = document.getElementById("statusBox");
        if (lines.length) {
          document.getElementById("statusText").textContent = lines.join(" ¬∑ ");
          box.style.display = "flex";
        } else {
          box.style.display = "none";
        }
      } catch { document.getElementById("statusBox").style.display = "none"; }
    }

    async function refreshData() {
      const btn = document.getElementById("refreshBtn");
      btn.disabled = true; btn.textContent = "‚åõ";
      // Trigger webapp
      (new Image()).src = `${TRIGGER_WEBAPP_URL}?token=${TRIGGER_TOKEN}&t=${Date.now()}`;
      lineData[currentLine] = null; // force reload
      setTimeout(async () => {
        await loadLine(currentLine, true);
        await loadStatusBox();
        btn.disabled = false; btn.textContent = "‚Ü∫ –û–±–Ω–æ–≤–∏—Ç—å";
      }, 3000);
    }

    function switchLine(lineKey) {
      currentLine = lineKey;
      document.querySelectorAll('.line-tab').forEach(t => t.classList.toggle('active', t.dataset.line === lineKey));
      document.getElementById("tableSearch").value = "";
      loadLine(lineKey);
      updateReportSection();
      saveState();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  EXPORT REPORT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function exportReport() {
      const name = document.getElementById('workerName').value || '–ò–Ω–∂–µ–Ω–µ—Ä';
      const date = document.getElementById('workDate').value || new Date().toLocaleDateString('ru-RU');
      const info = labelCounts[currentLine];
      const lineLabel = currentLine === "kns" ? "–ö–ù–°" : currentLine === "2" ? "–õ–∏–Ω–∏—è 3" : `–õ–∏–Ω–∏—è ${currentLine}`;
      const pct = info.total > 0 ? Math.round((info.done / info.total) * 100) : 0;

      let report = `üìã –û—Ç—á—ë—Ç –ø–æ –æ–±—Ö–æ–¥—É\n`;
      report += `${date}\n`;
      report += `–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${name}\n`;
      report += `–ú–∞—Ä—à—Ä—É—Ç: ${lineLabel}\n`;
      report += `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${info.done}/${info.total} –º–µ—Ç–æ–∫ (${pct}%)\n`;

      const countNew = parseInt(document.getElementById('countNew').textContent) || 0;
      const countLost = parseInt(document.getElementById('countLost').textContent) || 0;
      const notesNew = document.getElementById('notesNew').value.trim();
      const notesLost = document.getElementById('notesLost').value.trim();

      if (countNew > 0) {
        report += `\n–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏: ${countNew} —à—Ç.`;
        if (notesNew) report += `\n–ù–æ–º–µ—Ä–∞: ${notesNew}`;
        report += `\n`;
      }
      if (countLost > 0) {
        report += `\n–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –º–µ—Ç–∫–∏: ${countLost} —à—Ç.`;
        if (notesLost) report += `\n–ù–æ–º–µ—Ä–∞: ${notesLost}`;
        report += `\n`;
      }

      navigator.clipboard.writeText(report)
        .then(() => alert('‚úÖ –û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n–í—Å—Ç–∞–≤—å—Ç–µ –≤ Telegram –∏–ª–∏ –¥—Ä—É–≥–æ–π —á–∞—Ç.'))
        .catch(() => prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç:', report));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CONFETTI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showConfetti() {
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth; canvas.height = window.innerHeight;
      const pieces = [];
      const colors = ['#00b0ff','#34d399','#f59e0b','#f87171','#a78bfa'];
      for (let i = 0; i < 120; i++) {
        pieces.push({
          x: Math.random() * canvas.width, y: -10,
          vx: (Math.random() - 0.5) * 8, vy: Math.random() * 5 + 3,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 7 + 3,
          rot: Math.random() * 360, rotV: (Math.random() - 0.5) * 8
        });
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pieces.forEach((p, i) => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.rotV;
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
          ctx.fillStyle = p.color; ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
          if (p.y > canvas.height) pieces.splice(i, 1);
        });
        if (pieces.length) requestAnimationFrame(animate);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      animate();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('workDate').valueAsDate = new Date();

      // Logo fallback
      const logo = document.querySelector('header img');
      if (logo) logo.addEventListener('error', () => {
        logo.style.display = 'none';
        document.getElementById('logoFallback').style.display = 'inline';
      });

      loadState();

      // Toggle checklist groups
      document.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('open');
          saveState();
        });
      });

      // Subtask clicks
      document.querySelectorAll('.subtask').forEach(subtask => {
        subtask.addEventListener('click', function(e) {
          const checkbox = this.querySelector('input[type="checkbox"]');
          if (e.target !== checkbox && checkbox) {
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('completed', checkbox.checked);
          }
          saveState();
          updateAllProgress();
        });
      });

      // Table group toggle
      const tableGroupHeader = document.querySelector('.table-group-header');
      const tableGroup = document.querySelector('[data-tgroup="lines"]');
      tableGroupHeader.addEventListener('click', () => {
        const wasOpen = tableGroup.classList.contains('open');
        tableGroup.classList.toggle('open');
        if (!wasOpen) {
          // Load all lines for badge counts
          ["1","2","kns"].forEach(k => { if (!lineData[k]) loadLine(k); });
          loadStatusBox();
        }
        saveState();
      });

      // Line tabs
      document.querySelectorAll('.line-tab').forEach(tab => {
        tab.addEventListener('click', () => switchLine(tab.dataset.line));
      });

      // Tag event notes autosave
      document.getElementById('notesNew').addEventListener('input', saveState);
      document.getElementById('notesLost').addEventListener('input', saveState);

      // Auto-load if table was open
      if (document.querySelector('[data-tgroup="lines"]').classList.contains('open')) {
        ["1","2","kns"].forEach(k => loadLine(k));
        loadStatusBox();
      }

      // Intro fields save
      document.getElementById('workDate').addEventListener('change', saveState);
      document.getElementById('workerName').addEventListener('input', saveState);
    });

    window.addEventListener('beforeunload', saveState);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) saveState(); });
  </script>
</body>
</html>
