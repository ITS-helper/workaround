<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ß–µ–∫-–ª–∏—Å—Ç ‚Äî –õ–∏–Ω–∏–∏ –∏ –ö–ù–°</title>
  <meta name="theme-color" content="#0b2740">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    /* Cluster styling */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-clip: padding-box; border-radius: 50%; }
    .marker-cluster-small { background-color: rgba(0,176,255,0.25); }
    .marker-cluster-small div { background-color: rgba(0,176,255,0.7); }
    .marker-cluster-medium { background-color: rgba(245,158,11,0.25); }
    .marker-cluster-medium div { background-color: rgba(245,158,11,0.7); }
    .marker-cluster-large { background-color: rgba(239,68,68,0.25); }
    .marker-cluster-large div { background-color: rgba(239,68,68,0.7); }
    .marker-cluster div {
      width: 30px; height: 30px; margin-left: 5px; margin-top: 5px;
      text-align: center; border-radius: 50%;
      font-family: 'Oswald', sans-serif; font-size: 13px; font-weight: 700;
      color: #fff; display: flex; align-items: center; justify-content: center;
    }
    .marker-cluster span { line-height: 1; }
  </style>
  <style>
    :root {
      --primary: #0b2740;
      --secondary: #123b63;
      --accent: #00b0ff;
      --bg-main: #eef2f8;
      --card-bg: #ffffff;
      --muted: #5a6a7e;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --progress-bg: #dde4ee;
      --glass-bg: rgba(255,255,255,0.92);
      --border: #dde4ee;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Source Sans 3', sans-serif;
      background: var(--bg-main);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(0,176,255,0.07) 0%, transparent 55%),
        radial-gradient(ellipse at 80% 100%, rgba(11,39,64,0.07) 0%, transparent 55%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #1a2a3a;
    }
    header {
      background: linear-gradient(90deg, #0b2740 0%, #0e3359 60%, #123b63 100%);
      padding: 0;
      box-shadow: 0 4px 24px rgba(11,39,64,0.45), 0 2px 0 rgba(0,176,255,0.3);
      position: sticky; top: 0; z-index: 100;
      /* border-bottom —É–±—Ä–∞–Ω ‚Äî –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ box-shadow —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –Ω–∞ iOS */
      transform: translateZ(0); /* —Ñ–æ—Ä—Å–∏—Ä—É–µ–º GPU-—Å–ª–æ–π, —É–±–∏—Ä–∞–µ—Ç –≥–ª—é–∫ –Ω–∞ Safari */
      -webkit-transform: translateZ(0);
    }
    .header-inner {
      max-width: 960px; margin: 0 auto;
      padding: 14px 20px; display: flex; align-items: center; gap: 16px;
    }
    header .logo-text {
      font-family: 'Oswald', sans-serif; font-size: 1.25em; font-weight: 600;
      color: #fff; letter-spacing: 0.08em; text-transform: uppercase;
    }
    header img {
      height: 36px; width: auto; max-width: 160px; object-fit: contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
    }
    .header-title {
      font-family: 'Oswald', sans-serif; font-size: 0.75em; font-weight: 500;
      letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.5);
      border-left: 1px solid rgba(255,255,255,0.2); padding-left: 16px;
    }
    .container { max-width: 960px; margin: 0 auto 40px auto; padding: 24px 20px; }
    h1 {
      font-family: 'Oswald', sans-serif; color: var(--primary);
      margin: 0 0 24px 0; font-size: 1.9em; font-weight: 600;
      letter-spacing: 0.04em; text-align: center; text-transform: uppercase;
    }
    .intro {
      background: var(--glass-bg); padding: 18px 22px; border-radius: 12px;
      margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 14px;
      align-items: center; border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(11,39,64,0.08);
    }
    .intro-field { display: flex; align-items: center; gap: 8px; }
    .intro-field label {
      font-family: 'Oswald', sans-serif; font-size: 0.78em; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--muted); font-weight: 500; white-space: nowrap;
    }
    .intro input[type="date"], .intro input[type="text"] {
      padding: 7px 11px; border: 1px solid var(--border); border-radius: 7px;
      font-size: 14px; font-family: 'Source Sans 3', sans-serif;
      background: #f8fafc; color: #1a2a3a; transition: border-color 0.2s;
    }
    .intro input:focus { outline: none; border-color: var(--accent); background: #fff; }
    .intro input::placeholder { color: #a0b0c0; }
    #workDate { width: 160px; } #workerName { width: 180px; }
    .intro-hint {
      font-size: 12px; color: var(--muted); width: 100%; margin: 0;
      padding-top: 4px; border-top: 1px solid var(--border);
    }

    /* ===== REMINDERS ===== */
    .reminders-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .reminder-banner {
      display: flex; align-items: center; gap: 12px; padding: 14px 18px;
      border-radius: 10px; background: linear-gradient(90deg, #eef6ff 0%, #f0f7ff 100%);
      border: 1px solid #bfdbfe; border-left: 4px solid var(--accent);
      box-shadow: 0 2px 10px rgba(0,176,255,0.10); animation: reminderSlideIn 0.4s ease-out;
    }
    @keyframes reminderSlideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .reminder-icon { flex-shrink: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
    .reminder-icon svg { width: 20px; height: 20px; }
    .reminder-content { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .reminder-title { font-family: 'Oswald', sans-serif; font-size: 0.82em; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--primary); }
    .reminder-text { font-size: 13.5px; color: #1e3a5f; line-height: 1.4; }
    .reminder-close {
      width: 28px; height: 28px; border-radius: 50%; border: none;
      background: rgba(0,176,255,0.08); color: var(--primary); font-size: 16px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: background 0.15s; line-height: 1; padding: 0;
    }
    .reminder-close:hover { background: rgba(0,176,255,0.18); }
    .reminder-banner.hidden { display: none; }

    .task-group {
      margin-bottom: 16px; background: var(--card-bg); border-radius: 12px;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07); border: 1px solid var(--border);
      overflow: hidden; transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .task-group:hover { box-shadow: 0 8px 28px rgba(11,39,64,0.12); border-color: rgba(0,176,255,0.35); }
    .group-header {
      padding: 16px 20px 14px; cursor: pointer; user-select: none;
      display: flex; flex-direction: column; gap: 10px; transition: background 0.2s;
    }
    .group-header:hover { background: #f7fafd; }
    .group-title-row { display: flex; align-items: center; justify-content: space-between; }
    .task-group h2 {
      font-family: 'Oswald', sans-serif; color: var(--primary); margin: 0;
      font-size: 1.05em; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
      display: flex; align-items: center; gap: 10px;
    }
    .task-group h2 .icon { font-size: 1.1em; line-height: 1; }
    .group-chevron { color: var(--muted); font-size: 18px; transition: transform 0.3s ease; flex-shrink: 0; }
    .task-group.open .group-chevron { transform: rotate(180deg); }
    .progress-container { height: 4px; background: var(--progress-bg); border-radius: 999px; overflow: hidden; }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, #34d399 100%);
      width: 0%; transition: width 0.4s ease; border-radius: 999px;
      box-shadow: 0 0 8px rgba(0,176,255,0.5);
    }
    .subtasks { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    .task-group.open .subtasks { max-height: 4000px; }
    .subtasks-inner { padding: 6px 16px 16px; display: flex; flex-direction: column; gap: 6px; }
    .subtask {
      display: flex; align-items: center; padding: 12px 14px; background: #f8fafc;
      border-radius: 9px; border-left: 3px solid transparent; cursor: pointer;
      transition: all 0.18s ease; gap: 12px;
    }
    .subtask:hover { background: #f0f6ff; border-left-color: var(--accent); }
    .subtask.completed { background: #f0fdf8; border-left-color: var(--success); }
    .subtask input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
    .subtask span { font-size: 14px; color: #2a3a4a; flex: 1; line-height: 1.4; font-weight: 400; }
    .subtask.completed span { text-decoration: line-through; color: #94a3b8; }
    .table-group {
      margin-bottom: 16px; background: var(--card-bg); border-radius: 12px;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07); border: 1px solid var(--border);
      overflow: hidden; transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .table-group:hover { box-shadow: 0 8px 28px rgba(11,39,64,0.12); border-color: rgba(0,176,255,0.35); }
    .table-group-header {
      padding: 16px 20px 14px; cursor: pointer; user-select: none;
      display: flex; flex-direction: column; gap: 10px; transition: background 0.2s;
    }
    .table-group-header:hover { background: #f7fafd; }
    .table-group h2 {
      font-family: 'Oswald', sans-serif; color: var(--primary); margin: 0;
      font-size: 1.05em; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
      display: flex; align-items: center; gap: 10px;
    }
    .table-group.open .group-chevron { transform: rotate(180deg); }
    .table-body { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    .table-group.open .table-body { max-height: 4000px; }
    .table-inner { padding: 0 16px 16px; }
    .line-tabs { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
    .line-tab {
      font-family: 'Oswald', sans-serif; font-size: 0.8em; letter-spacing: 0.08em;
      text-transform: uppercase; font-weight: 600; padding: 7px 16px; border-radius: 999px;
      border: 1px solid var(--border); background: #f8fafc; color: var(--muted);
      cursor: pointer; transition: all 0.18s ease; display: flex; align-items: center; gap: 6px;
    }
    .line-tab:hover { background: #f0f6ff; border-color: var(--accent); color: var(--primary); }
    .line-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 14px rgba(11,39,64,0.3); }
    .line-tab .tab-badge { background: rgba(255,255,255,0.2); border-radius: 999px; padding: 1px 7px; font-size: 0.85em; min-width: 24px; text-align: center; }
    .line-tab:not(.active) .tab-badge { background: rgba(0,176,255,0.12); color: var(--accent); }
    .table-search { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .table-search input {
      flex: 1; padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 14px; font-family: 'Source Sans 3', sans-serif; background: #f8fafc;
      color: #1a2a3a; transition: border-color 0.2s;
    }
    .table-search input:focus { outline: none; border-color: var(--accent); background: #fff; }
    .table-search input::placeholder { color: #a0b0c0; }
    .refresh-btn {
      font-family: 'Oswald', sans-serif; font-size: 0.8em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 8px 14px; border-radius: 8px;
      border: 1px solid var(--border); background: #f8fafc; color: var(--primary);
      cursor: pointer; transition: all 0.18s ease; white-space: nowrap;
    }
    .refresh-btn:hover { background: #f0f6ff; border-color: var(--accent); }
    .refresh-btn:disabled { opacity: 0.5; cursor: default; }
    .status-box {
      display: flex; align-items: center; gap: 8px; padding: 8px 14px;
      background: #f0fdf8; border: 1px solid #a7f3d0; border-radius: 8px;
      font-size: 13px; color: #065f46; margin-bottom: 12px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); flex-shrink: 0; }
    .data-table-wrap { border-radius: 10px; border: 1px solid var(--border); overflow: auto; max-height: 420px; }
    .data-table { min-width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table thead th {
      position: sticky; top: 0; background: #f0f4f9; padding: 10px 14px; text-align: left;
      font-family: 'Oswald', sans-serif; font-size: 0.78em; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--muted); font-weight: 600; white-space: nowrap;
      border-bottom: 2px solid var(--border); z-index: 10;
    }
    .data-table tbody td { padding: 10px 14px; border-bottom: 1px solid var(--border); white-space: nowrap; color: #2a3a4a; }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .data-table tbody tr { transition: background 0.15s; }
    .data-table tbody tr:hover { background: #f7fafd; }
    .data-table tbody tr.row-done { background: #f0fdf8; }
    .data-table tbody tr.row-done td { color: #6b7280; }
    .data-table tbody tr.row-wait { background: #fff8ed; }
    .table-loading { text-align: center; padding: 32px; color: var(--muted); font-size: 14px; }
    .table-empty { text-align: center; padding: 24px; color: var(--muted); font-size: 14px; }
    .table-error { text-align: center; padding: 24px; color: #e11d48; font-size: 14px; }
    .count-chip {
      display: inline-flex; align-items: center; gap: 4px; background: rgba(0,176,255,0.1);
      border-radius: 999px; padding: 2px 10px; font-size: 12px; color: var(--accent);
      font-family: 'Oswald', sans-serif; font-weight: 600; letter-spacing: 0.04em;
    }
    .count-chip.done { background: rgba(16,185,129,0.12); color: var(--success); }
    .tag-events { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    @media (max-width: 540px) { .tag-events { grid-template-columns: 1fr; } }
    .tag-event-block {
      border-radius: 10px; border: 1px solid var(--border); padding: 12px 14px;
      background: #f8fafc; display: flex; flex-direction: column; gap: 10px;
    }
    .tag-event-new { border-left: 3px solid var(--success); }
    .tag-event-lost { border-left: 3px solid #f87171; }
    .tag-event-header { display: flex; align-items: center; gap: 8px; }
    .tag-event-icon {
      font-size: 15px; font-weight: 700; width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
      font-family: 'Oswald', sans-serif;
    }
    .tag-event-new .tag-event-icon { background: rgba(16,185,129,0.15); color: var(--success); }
    .tag-event-lost .tag-event-icon { background: rgba(248,113,113,0.15); color: #e11d48; }
    .tag-event-title {
      font-family: 'Oswald', sans-serif; font-size: 0.82em; font-weight: 600;
      letter-spacing: 0.07em; text-transform: uppercase; color: var(--primary); flex: 1;
    }
    .tag-event-counter { display: flex; align-items: center; gap: 6px; }
    .tag-event-counter span {
      font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 1.15em;
      min-width: 24px; text-align: center; color: var(--primary);
    }
    .counter-btn {
      width: 26px; height: 26px; border-radius: 50%; border: 1px solid var(--border);
      background: #fff; color: var(--primary); font-size: 16px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; line-height: 1; padding: 0;
    }
    .counter-btn:hover { background: #f0f6ff; border-color: var(--accent); }
    .tag-event-notes {
      width: 100%; min-height: 56px; resize: vertical; padding: 8px 10px;
      border: 1px solid var(--border); border-radius: 7px; font-size: 13px;
      font-family: 'Source Sans 3', sans-serif; background: #fff; color: #1a2a3a;
      transition: border-color 0.2s; line-height: 1.4;
    }
    .tag-event-notes:focus { outline: none; border-color: var(--accent); }
    .tag-event-notes::placeholder { color: #a0b0c0; }
    .report-section {
      margin-top: 8px; background: var(--glass-bg); border-radius: 12px;
      border: 1px solid var(--border); box-shadow: 0 4px 16px rgba(11,39,64,0.07);
      padding: 20px 24px; display: flex; align-items: center;
      justify-content: space-between; gap: 16px; flex-wrap: wrap;
    }
    .report-line-info { font-size: 14px; color: var(--muted); flex: 1; min-width: 180px; }
    .report-line-info strong { color: var(--primary); font-weight: 600; }
    .report-line-info .pct {
      font-family: 'Oswald', sans-serif; font-size: 1.5em; font-weight: 700;
      color: var(--accent); margin-right: 6px;
    }
    .report-line-info .pct.pct-done { color: var(--success); }
    .btn-report {
      font-family: 'Oswald', sans-serif; font-size: 0.95em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 11px 24px; border-radius: 999px;
      border: none; background: var(--accent); color: #04111f; cursor: pointer;
      transition: all 0.2s ease; white-space: nowrap; flex-shrink: 0;
      box-shadow: 0 4px 14px rgba(0,176,255,0.3);
    }
    .btn-report:hover:not(:disabled) { background: #19b9ff; box-shadow: 0 6px 20px rgba(0,176,255,0.45); transform: translateY(-1px); }
    .btn-report:disabled { background: var(--progress-bg); color: var(--muted); box-shadow: none; cursor: default; }
    #confetti { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000; }

    .map-section {
      margin-bottom: 16px; background: var(--card-bg); border-radius: 12px;
      box-shadow: 0 4px 16px rgba(11,39,64,0.07); border: 1px solid var(--border);
      overflow: hidden; transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }
    .map-section:hover { box-shadow: 0 8px 28px rgba(11,39,64,0.12); border-color: rgba(0,176,255,0.35); }
    .map-section-header {
      padding: 16px 20px 14px; cursor: pointer; user-select: none;
      display: flex; flex-direction: column; gap: 10px; transition: background 0.2s;
    }
    .map-section-header:hover { background: #f7fafd; }
    .map-section h2 {
      font-family: 'Oswald', sans-serif; color: var(--primary); margin: 0;
      font-size: 1.05em; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
      display: flex; align-items: center; gap: 10px;
    }
    .map-section.open .group-chevron { transform: rotate(180deg); }
    .map-body { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    .map-section.open .map-body { max-height: 4000px; }
    .map-inner { padding: 0 16px 16px; }
    .map-auth-bar {
      display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;
    }
    .map-auth-bar input {
      flex: 1; min-width: 140px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 13px; font-family: 'Source Sans 3', sans-serif; background: #f8fafc; color: #1a2a3a;
    }
    .map-auth-bar input:focus { outline: none; border-color: var(--accent); background: #fff; }
    .map-auth-bar input::placeholder { color: #a0b0c0; }
    .map-auth-btn {
      font-family: 'Oswald', sans-serif; font-size: 0.8em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 8px 16px; border-radius: 8px;
      border: 1px solid var(--accent); background: var(--accent); color: #04111f;
      cursor: pointer; transition: all 0.18s ease; white-space: nowrap;
    }
    .map-auth-btn:hover { background: #19b9ff; }
    .map-auth-btn:disabled { opacity: 0.5; cursor: default; }
    .map-filters {
      display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;
    }
    .map-filter-btn {
      font-family: 'Oswald', sans-serif; font-size: 0.75em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 6px 14px; border-radius: 999px;
      border: 1px solid var(--border); background: #f8fafc; color: var(--muted);
      cursor: pointer; transition: all 0.18s ease; display: flex; align-items: center; gap: 5px;
    }
    .map-filter-btn:hover { background: #f0f6ff; border-color: var(--accent); color: var(--primary); }
    .map-filter-btn.active { color: #fff; border-color: transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .map-filter-btn.filter-all.active { background: var(--primary); }
    .map-filter-btn.filter-ok.active { background: var(--success); }
    .map-filter-btn.filter-battery.active { background: var(--danger); }
    .map-filter-btn.filter-inspection.active { background: var(--warning); color: #78350f; }
    .map-filter-btn .filter-count {
      font-size: 0.9em; background: rgba(255,255,255,0.25); border-radius: 999px;
      padding: 0 6px; min-width: 18px; text-align: center;
    }
    .map-stats {
      display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;
    }
    .map-stat {
      display: flex; align-items: center; gap: 5px; font-size: 12px;
      font-family: 'Oswald', sans-serif; font-weight: 600; letter-spacing: 0.04em;
      background: rgba(0,176,255,0.08); border-radius: 999px; padding: 3px 10px;
    }
    .map-stat .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dot-ok { background: var(--success); }
    .dot-battery { background: var(--danger); }
    .dot-inspection { background: var(--warning); }
    #bleMap {
      width: 100%; height: 420px; border-radius: 10px; border: 1px solid var(--border);
      background: #e8ecf2; position: relative; z-index: 1;
    }
    .map-placeholder {
      display: flex; align-items: center; justify-content: center; height: 100%;
      color: var(--muted); font-size: 14px; text-align: center; padding: 20px;
    }
    .map-search-bar {
      display: flex; gap: 8px; margin-bottom: 10px; align-items: center; position: relative;
    }
    .map-search-bar input {
      flex: 1; padding: 10px 36px 10px 14px; border: 2px solid var(--accent); border-radius: 10px;
      font-size: 16px; font-family: 'Source Sans 3', sans-serif; background: #fff; color: #1a2a3a;
      box-shadow: 0 2px 8px rgba(0,176,255,0.15);
    }
    .map-search-bar input:focus { outline: none; border-color: var(--primary); background: #fff; }
    .map-search-bar input::placeholder { color: #a0b0c0; }
    .map-search-clear {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--muted);
      font-size: 18px; line-height: 1; padding: 4px; display: none;
    }
    .map-search-clear:hover { color: var(--danger); }
    @media (max-width: 600px) {
      #bleMap { height: calc(100vh - 180px); border-radius: 8px; }
      .map-search-bar input { font-size: 16px; }
    }
    .map-msg {
      text-align: center; padding: 14px; font-size: 13px; color: var(--muted);
      border: 1px dashed var(--border); border-radius: 8px; margin-bottom: 12px;
    }
    .map-msg.error { color: var(--danger); border-color: rgba(239,68,68,0.3); background: #fef2f2; }
    .map-msg.ok { color: var(--success); border-color: rgba(16,185,129,0.3); background: #f0fdf8; }
    .ble-dot {
      width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 9px; font-weight: 700; color: #fff;
      font-family: 'Oswald', sans-serif; letter-spacing: 0.02em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid #fff;
      transition: transform 0.15s;
    }
    .ble-dot:hover { transform: scale(1.2); }
    .ble-dot-ok { background: var(--success); }
    .ble-dot-battery { background: var(--danger); animation: pulse-red 2s infinite; }
    .ble-dot-inspection { background: var(--warning); border-color: #fbbf24; }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      50% { box-shadow: 0 0 0 6px rgba(239,68,68,0); }
    }
    .map-layer-toggle {
      display: flex; gap: 6px;
    }
    .map-layer-btn {
      font-family: 'Oswald', sans-serif; font-size: 0.78em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 6px 14px; border-radius: 999px;
      border: 1px solid var(--border); background: #f8fafc; color: var(--muted);
      cursor: pointer; transition: all 0.18s ease;
    }
    .map-layer-btn:hover { background: #f0f6ff; border-color: var(--accent); color: var(--primary); }
    .map-layer-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(11,39,64,0.3); }
    @media (max-width: 500px) {
      h1 { font-size: 1.4em; }
      #bleMap { height: 320px; }
    }
    @supports (padding: max(0px)) { .actions { bottom: max(16px, env(safe-area-inset-bottom)); } }

    /* ===== POPUP ===== */
    .leaflet-popup-content-wrapper {
      border-radius: 10px !important;
      box-shadow: 0 8px 24px rgba(11,39,64,0.18) !important;
      padding: 0 !important;
    }
    .leaflet-popup-content {
      margin: 12px 14px !important;
    }
    .leaflet-popup-tip-container { margin-top: -1px; }

    /* ===== FULLSCREEN MAP ===== */
    .map-fullscreen-btn {
      font-family: 'Oswald', sans-serif; font-size: 0.78em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 6px 14px; border-radius: 999px;
      border: 1px solid var(--border); background: #f8fafc; color: var(--muted);
      cursor: pointer; transition: all 0.18s ease; display: flex; align-items: center; gap: 6px;
    }
    .map-fullscreen-btn:hover { background: #f0f6ff; border-color: var(--accent); color: var(--primary); }
    .map-fullscreen-overlay {
      position: fixed; inset: 0; z-index: 9000;
      background: #1a2a3a; display: flex; flex-direction: column;
      opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    }
    .map-fullscreen-overlay.open { opacity: 1; pointer-events: all; }
    .map-fullscreen-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: linear-gradient(90deg, #0b2740, #123b63);
      flex-shrink: 0; gap: 8px;
    }
    .map-fullscreen-title {
      font-family: 'Oswald', sans-serif; font-size: 0.9em; font-weight: 600;
      letter-spacing: 0.07em; text-transform: uppercase; color: #fff;
      display: flex; align-items: center; gap: 8px;
    }
    .map-fullscreen-close {
      font-family: 'Oswald', sans-serif; font-size: 0.8em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 7px 16px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.1);
      color: #fff; cursor: pointer; transition: all 0.18s ease;
    }
    .map-fullscreen-close:hover { background: rgba(255,255,255,0.2); }
    .map-fullscreen-controls {
      display: flex; gap: 6px; padding: 8px 14px; flex-wrap: wrap; align-items: center;
      background: rgba(11,39,64,0.85); flex-shrink: 0;
    }
    .map-fullscreen-controls .map-filter-btn { font-size: 0.72em; padding: 5px 11px; }
    .map-fullscreen-search {
      display: flex; align-items: center; padding: 6px 14px; flex-shrink: 0;
      background: rgba(11,39,64,0.7); position: relative;
    }
    .map-fullscreen-search input {
      width: 100%; padding: 9px 34px 9px 14px; border: 1.5px solid rgba(0,176,255,0.5);
      border-radius: 8px; font-size: 15px; font-family: 'Source Sans 3', sans-serif;
      background: rgba(255,255,255,0.97); color: #1a2a3a;
    }
    .map-fullscreen-search input:focus { outline: none; border-color: var(--accent); }
    .map-fullscreen-search input::placeholder { color: #a0b0c0; }
    .map-fullscreen-search-clear {
      position: absolute; right: 22px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--muted);
      font-size: 18px; line-height: 1; padding: 4px; display: none;
    }
    .map-fullscreen-layer {
      display: flex; gap: 6px; padding: 6px 14px 8px;
      background: rgba(11,39,64,0.7); flex-shrink: 0;
    }
    .map-fullscreen-layer .map-layer-btn { font-size: 0.72em; padding: 5px 11px; }
    #bleMapFS {
      flex: 1; width: 100%; min-height: 0;
    }

    /* ===== MODAL REPORT ===== */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(11,39,64,0.55);
      backdrop-filter: blur(4px); z-index: 500;
      display: flex; align-items: center; justify-content: center;
      padding: 16px; opacity: 0; pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: #fff; border-radius: 16px; width: 100%; max-width: 520px;
      box-shadow: 0 24px 64px rgba(11,39,64,0.3); display: flex; flex-direction: column;
      max-height: 90vh; transform: translateY(20px); transition: transform 0.25s ease;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-header {
      padding: 18px 20px 14px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h3 {
      font-family: 'Oswald', sans-serif; font-size: 1em; font-weight: 600;
      letter-spacing: 0.07em; text-transform: uppercase; color: var(--primary); margin: 0;
    }
    .modal-close {
      width: 30px; height: 30px; border-radius: 50%; border: none;
      background: #f0f4f9; color: var(--muted); font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.15s;
    }
    .modal-close:hover { background: #fee2e2; color: var(--danger); }
    .modal-body { padding: 16px 20px; flex: 1; overflow-y: auto; }
    .modal-body textarea {
      width: 100%; min-height: 220px; resize: vertical;
      padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px;
      font-size: 14px; font-family: 'Source Sans 3', sans-serif;
      line-height: 1.6; color: #1a2a3a; background: #f8fafc;
      transition: border-color 0.2s;
    }
    .modal-body textarea:focus { outline: none; border-color: var(--accent); background: #fff; }
    .modal-footer {
      padding: 14px 20px; border-top: 1px solid var(--border);
      display: flex; gap: 10px; justify-content: flex-end;
    }
    .btn-copy {
      font-family: 'Oswald', sans-serif; font-size: 0.9em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 10px 22px; border-radius: 999px;
      border: none; background: var(--accent); color: #04111f; cursor: pointer;
      transition: all 0.2s ease; box-shadow: 0 4px 14px rgba(0,176,255,0.3);
      display: flex; align-items: center; gap: 8px;
    }
    .btn-copy:hover { background: #19b9ff; transform: translateY(-1px); }
    .btn-copy.copied { background: var(--success); box-shadow: 0 4px 14px rgba(16,185,129,0.3); }
    .btn-cancel {
      font-family: 'Oswald', sans-serif; font-size: 0.9em; letter-spacing: 0.06em;
      text-transform: uppercase; font-weight: 600; padding: 10px 18px; border-radius: 999px;
      border: 1px solid var(--border); background: #f8fafc; color: var(--muted); cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-cancel:hover { background: #f0f4f9; color: var(--primary); }
    @media (max-width: 500px) {
      .modal { max-height: 95vh; border-radius: 12px; }
      .modal-footer { flex-direction: column; }
      .btn-copy, .btn-cancel { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <img src="./images/ITS_logo_horizont.png" alt="ITSSupport" onerror="this.style.display='none'">
      <span class="logo-text" id="logoFallback" style="display:none">ITSSupport</span>
      <span class="header-title">–ß–µ–∫-–ª–∏—Å—Ç —Å–º–µ–Ω—ã</span>
    </div>
  </header>

  <div class="container">
    <div class="intro">
      <div class="intro-field">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="workDate">
      </div>
      <div class="intro-field">
        <label>–ö–æ–º–∞–Ω–¥–∞</label>
        <input type="text" id="workerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã">
      </div>
      <p class="intro-hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á–∏ ¬∑ –û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∫–ª–∏–∫–æ–º</p>
    </div>

    <div class="reminders-container" id="remindersContainer"></div>

    <div class="task-group" data-group="morning">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M12 2v4M4.93 7.93l2.83 2.83M2 16h4M18 16h4M16.24 10.76l2.83-2.83M5 16a7 7 0 0 1 14 0"/><line x1="3" y1="20" x2="21" y2="20"/></svg></span> –£—Ç—Ä–æ (6:00‚Äì8:00)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="morning"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask">
          <input type="checkbox" data-task-id="morning-2">
          <span>–í—ã–¥–∞—á–∞ —á–∞—Å–æ–≤ –≤ –æ–∫–Ω–µ 6:00‚Äì8:00. –£–±–æ—Ä–∫–∞ –ø–æ–ª–æ–∫ —Å —á–∞—Å–∞–º–∏</span>
        </div>
      </div></div>
    </div>

    <div class="task-group" data-group="prep">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±—Ö–æ–¥—É</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="prep"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask"><input type="checkbox" data-task-id="prep-1"><span>–ó–∞–ø—É—Å–∫ —Å–º–µ–Ω—ã –Ω–∞ —á–∞—Å–∞—Ö, –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span></div>
        <div class="subtask"><input type="checkbox" data-task-id="prep-2"><span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span></div>
        <div class="subtask"><input type="checkbox" data-task-id="prep-3"><span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—é–∫–∑–∞–∫–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º</span></div>
        <div class="subtask"><input type="checkbox" data-task-id="prep-4"><span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Ü–∏–∏</span></div>
      </div></div>
    </div>

    <div class="table-group" data-tgroup="lines">
      <div class="table-group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><polyline points="6.5 6.5 17.5 17.5 12 23 12 1 17.5 6.5 6.5 17.5"/></svg></span> –û–±—Ö–æ–¥ –ø–æ –º–µ—Ç–∫–∞–º</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="linesProgressBar"></div></div>
      </div>
      <div class="table-body">
        <div class="table-inner">
          <div class="line-tabs">
            <button class="line-tab active" data-line="1">–õ–∏–Ω–∏—è 1 <span class="tab-badge" id="badge1">‚Äî</span></button>
            <button class="line-tab" data-line="2">–õ–∏–Ω–∏—è 3 <span class="tab-badge" id="badge2">‚Äî</span></button>
            <button class="line-tab" data-line="kns">–ö–ù–° <span class="tab-badge" id="badgeKns">‚Äî</span></button>
            <button class="line-tab" data-line="night">–ù–æ—á—å <span class="tab-badge" id="badgeNight">‚Äî</span></button>
          </div>
          <div class="status-box" id="statusBox" style="display:none">
            <div class="status-dot"></div>
            <span id="statusText"></span>
          </div>
          <div class="table-search">
            <input type="number" inputmode="numeric" id="tableSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ –º–µ—Ç–∫–∏...">
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">‚Ü∫ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          </div>
          <div class="data-table-wrap">
            <table class="data-table">
              <thead id="dataThead"></thead>
              <tbody id="dataTbody"><tr><td class="table-loading" colspan="99">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</td></tr></tbody>
            </table>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
            <span class="count-chip" id="chipTotal">–í—Å–µ–≥–æ: ‚Äî</span>
            <span class="count-chip done" id="chipDone">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <div class="map-section" data-map-section="ble">
      <div class="map-section-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></span> –ö–∞—Ä—Ç–∞ BLE-–º–µ—Ç–æ–∫</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
      </div>
      <div class="map-body">
        <div class="map-inner">
          <div id="mapAuthBlock" class="map-auth-bar" style="display:none"></div>
          <div id="mapMsg" class="map-msg" style="display:none"></div>
          <div style="text-align:center;margin-bottom:10px;display:none" id="mapRetryBtnWrap">
            <button class="map-auth-btn" id="mapRetryBtn" onclick="retryBleMap()" style="display:none">‚Ü∫ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
          </div>
          <div id="mapFiltersBlock" class="map-filters" style="display:none">
            <button class="map-filter-btn filter-all active" data-filter="all">–í—Å–µ <span class="filter-count" id="fcAll">0</span></button>
            <button class="map-filter-btn filter-ok" data-filter="ok">‚úì –í –Ω–æ—Ä–º–µ <span class="filter-count" id="fcOk">0</span></button>
            <button class="map-filter-btn filter-battery" data-filter="battery">–ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ <span class="filter-count" id="fcBat">0</span></button>
            <button class="map-filter-btn filter-inspection" data-filter="inspection">–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ <span class="filter-count" id="fcInsp">0</span></button>
          </div>
          <div id="mapSearchBlock" class="map-search-bar" style="display:none">
            <input type="text" id="mapBleSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –º–µ—Ç–∫–∏: 898 –∏–ª–∏ ble898" inputmode="numeric">
            <button class="map-search-clear" id="mapSearchClear" title="–û—á–∏—Å—Ç–∏—Ç—å">‚úï</button>
          </div>
          <div id="mapBottomControls" style="display:none;flex-wrap:wrap;gap:6px;margin-bottom:10px;align-items:center;">
            <button class="map-fullscreen-btn" id="mapFullscreenBtnWrap" onclick="openFullscreenMap()" style="margin-bottom:0;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
              –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
            </button>
            <div id="mapLayerToggle" class="map-layer-toggle" style="margin-bottom:0;">
              <button class="map-layer-btn" id="btnSatellite" data-layer="satellite">üõ∞ –°–ø—É—Ç–Ω–∏–∫</button>
              <button class="map-layer-btn active" id="btnStreet" data-layer="street">üó∫ –°—Ö–µ–º–∞</button>
            </div>
          </div>
          <div id="bleMap"><div class="map-placeholder" id="mapPlaceholder">–†–∞—Å–∫—Ä–æ–π—Ç–µ –±–ª–æ–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã‚Ä¶</div></div>
        </div>
      </div>
    </div>

    <div class="task-group" data-group="tag-events-block">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></span> –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ç–∫–∞–º</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="tag-events-block" style="width:0%"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="tag-events">
          <div class="tag-event-block tag-event-new">
            <div class="tag-event-header">
              <span class="tag-event-icon">Ôºã</span>
              <span class="tag-event-title">–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏</span>
              <div class="tag-event-counter">
                <button class="counter-btn" onclick="changeCount('new', -1)">‚àí</button>
                <span id="countNew">0</span>
                <button class="counter-btn" onclick="changeCount('new', 1)">Ôºã</button>
              </div>
            </div>
            <textarea id="notesNew" class="tag-event-notes" placeholder="–ù–æ–º–µ—Ä–∞ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–∫: 101, 205, 318"></textarea>
          </div>
          <div class="tag-event-block tag-event-lost">
            <div class="tag-event-header">
              <span class="tag-event-icon">‚àí</span>
              <span class="tag-event-title">–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –º–µ—Ç–∫–∏</span>
              <div class="tag-event-counter">
                <button class="counter-btn" onclick="changeCount('lost', -1)">‚àí</button>
                <span id="countLost">0</span>
                <button class="counter-btn" onclick="changeCount('lost', 1)">Ôºã</button>
              </div>
            </div>
            <textarea id="notesLost" class="tag-event-notes" placeholder="–ù–æ–º–µ—Ä–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫: 42, 77"></textarea>
          </div>
        </div>
      </div></div>
    </div>

    <div class="task-group" data-group="evening">
      <div class="group-header">
        <div class="group-title-row">
          <h2><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-top:-2px"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span> –í–µ—á–µ—Ä (18:00‚Äì19:30)</h2>
          <span class="group-chevron">‚ñº</span>
        </div>
        <div class="progress-container"><div class="progress-bar" data-group="evening"></div></div>
      </div>
      <div class="subtasks"><div class="subtasks-inner">
        <div class="subtask"><input type="checkbox" data-task-id="evening-1"><span>–û—Ç—á–µ—Ç –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö</span></div>
        <div class="subtask"><input type="checkbox" data-task-id="evening-2"><span>–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã / –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞</span></div>
      </div></div>
    </div>

    <div class="report-section">
      <div class="report-line-info" id="reportLineInfo">
        –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –≤ –±–ª–æ–∫–µ ¬´–û–±—Ö–æ–¥ –ø–æ –º–µ—Ç–∫–∞–º¬ª –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞
      </div>
      <button class="btn btn-report" id="reportBtn" onclick="exportReport()" disabled>
        ‚Üó –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç
      </button>
    </div>

  </div>

  <!-- MODAL REPORT -->
  <div class="modal-overlay" id="reportModal">
    <div class="modal">
      <div class="modal-header">
        <h3>‚úâÔ∏è –û—Ç—á—ë—Ç —Å–º–µ–Ω—ã</h3>
        <button class="modal-close" onclick="closeReportModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <textarea id="reportTextarea" spellcheck="false"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeReportModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn-copy" id="btnCopy" onclick="copyReport()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>
  <canvas id="confetti"></canvas>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const SHEET_ID = "1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c";
    const SHEET_NAME = "–î–ª—è –ø–µ—á–∞—Ç–∏üñ®Ô∏è";
    const STATUS_SHEET_NAME = "–°–≤–æ–¥_–∂—É—Ä–Ω–∞–ª–æ–≤_–°–ü–ì+–¢–°–ë";
    const STATUS_RANGE = "Q1:R2";
    const GROUPS = { "1": "D2:M200", "2": "R2:Z200", "kns": "AD2:AM200", "night": "AQ2:AZ200" };
    const TRIGGER_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzU7wYhYZxJu8_QvJMq174aPZ6lPeHu5PY6jqfyGbE1QgxZv0KwFVvgsDt_A2-wXUWA/exec";
    const TRIGGER_TOKEN = "12345";
    const STATUS_COL_NAME = "–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞";
    const STATUS_WAIT = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö";
    const STATUS_DONE = "–î–∞–Ω–Ω—ã–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã";
    const STORAGE_KEY = 'itssupport_cl2_v1';

    function saveState() {
      const state = {
        tasks: Array.from(document.querySelectorAll('input[type="checkbox"]'))
          .map(cb => ({ id: cb.dataset.taskId, checked: cb.checked })),
        date: document.getElementById('workDate').value,
        name: document.getElementById('workerName').value,
        groups: Array.from(document.querySelectorAll('.task-group'))
          .map(g => ({ id: g.dataset.group, open: g.classList.contains('open') })),
        tableOpen: document.querySelector('[data-tgroup="lines"]').classList.contains('open'),
        mapOpen: document.querySelector('[data-map-section="ble"]').classList.contains('open'),
        currentLine,
        countNew: document.getElementById('countNew').textContent,
        countLost: document.getElementById('countLost').textContent,
        notesNew: document.getElementById('notesNew').value,
        notesLost: document.getElementById('notesLost').value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved) {
          saved.tasks?.forEach(({ id, checked }) => {
            const cb = document.querySelector(`[data-task-id="${id}"]`);
            if (cb) { cb.checked = checked; cb.closest('.subtask').classList.toggle('completed', checked); }
          });
          if (saved.date) document.getElementById('workDate').value = saved.date;
          if (saved.name) document.getElementById('workerName').value = saved.name;
          saved.groups?.forEach(({ id, open }) => {
            const group = document.querySelector(`[data-group="${id}"]`);
            if (group && open) group.classList.add('open');
          });
          if (saved.tableOpen) document.querySelector('[data-tgroup="lines"]').classList.add('open');
          if (saved.mapOpen) document.querySelector('[data-map-section="ble"]').classList.add('open');
          if (saved.currentLine) currentLine = saved.currentLine;
          if (saved.countNew) document.getElementById('countNew').textContent = saved.countNew;
          if (saved.countLost) document.getElementById('countLost').textContent = saved.countLost;
          if (saved.notesNew) document.getElementById('notesNew').value = saved.notesNew;
          if (saved.notesLost) document.getElementById('notesLost').value = saved.notesLost;
        }
      } catch (e) {}
      updateAllProgress();
    }

    function updateGroupProgress(groupId) {
      const group = document.querySelector(`[data-group="${groupId}"]`);
      const tasks = group.querySelectorAll('input[type="checkbox"]');
      const checked = group.querySelectorAll('input[type="checkbox"]:checked').length;
      const percent = tasks.length ? Math.round((checked / tasks.length) * 100) : 0;
      group.querySelector('.progress-bar').style.width = percent + '%';
      return { checked, total: tasks.length };
    }

    function updateAllProgress() {
      document.querySelectorAll('.task-group').forEach(group => {
        if (group.dataset.group === 'tag-events-block') return;
        updateGroupProgress(group.dataset.group);
      });
    }

    function changeCount(type, delta) {
      const el = document.getElementById(type === 'new' ? 'countNew' : 'countLost');
      const current = parseInt(el.textContent) || 0;
      el.textContent = Math.max(0, current + delta);
      saveState();
    }

    function formatTagNumbers(raw) {
      if (!raw) return '';
      return raw.split(/[,;\s]+/).map(s => s.trim()).filter(Boolean).join(', ');
    }

    function updateReportSection() {
      const info = labelCounts[currentLine];
      const infoEl = document.getElementById("reportLineInfo");
      const btn = document.getElementById("reportBtn");
      if (!info || info.total === 0) {
        infoEl.innerHTML = `–û—Ç–∫—Ä–æ–π—Ç–µ –±–ª–æ–∫ ¬´–û–±—Ö–æ–¥ –ø–æ –º–µ—Ç–∫–∞–º¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç`;
        btn.disabled = true; return;
      }
      const pct = Math.round((info.done / info.total) * 100);
      const lineLabel = currentLine === "kns" ? "–ö–ù–°" : currentLine === "2" ? "–õ–∏–Ω–∏—è 3" : currentLine === "night" ? "–ù–æ—á—å" : `–õ–∏–Ω–∏—è ${currentLine}`;
      const isDone = pct === 100;
      infoEl.innerHTML = `<span class="pct ${isDone ? 'pct-done' : ''}">${pct}%</span> <strong>${lineLabel}</strong> ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${info.done} –∏–∑ ${info.total} –º–µ—Ç–æ–∫`;
      btn.disabled = false;
    }

    let currentLine = "1";
    let lineData = { "1": null, "2": null, "kns": null, "night": null };
    let labelCounts = { "1": { total: 0, done: 0 }, "2": { total: 0, done: 0 }, "kns": { total: 0, done: 0 }, "night": { total: 0, done: 0 } };

    function norm(s) { return String(s ?? "").toLowerCase().replace(/\s/g, ""); }
    function cellText(v) { return (v === null || v === undefined) ? "" : String(v); }
    function isIntLike(s) { return /^[0-9]+$/.test(String(s).trim()); }
    function esc(str) { return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])); }

    function updateBadges() {
      ["1","2","kns","night"].forEach(k => {
        const id = k === "kns" ? "badgeKns" : k === "night" ? "badgeNight" : "badge" + k;
        const el = document.getElementById(id);
        const info = labelCounts[k];
        el.textContent = info.total > 0 ? `${info.done}/${info.total}` : "‚Äî";
      });
      let total = 0, done = 0;
      Object.values(labelCounts).forEach(v => { total += v.total; done += v.done; });
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;
      document.getElementById("linesProgressBar").style.width = pct + '%';
    }

    async function loadLine(lineKey, force = false) {
      if (lineData[lineKey] && !force) { renderLine(lineKey); return; }
      setTableContent(`<tr><td class="table-loading" colspan="99">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>`);
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&range=${encodeURIComponent(GROUPS[lineKey])}&headers=1&t=${Date.now()}`;
      try {
        const res = await fetch(url); const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const table = json.table;
        const headers = table.cols.map(c => cellText(c.label || ""));
        let rows = table.rows.map(r => (r.c || []).map(c => cellText(c ? c.v : ""))).filter(row => row.some(c => c.trim() !== ""));
        const labelIdx = headers.findIndex(h => norm(h).includes("–º–µ—Ç–∫"));
        const statusIdx = headers.findIndex(h => norm(h) === norm(STATUS_COL_NAME));
        if (statusIdx !== -1) {
          rows.sort((a, b) => {
            const rank = v => {
              const s = v.trim();
              if (s === STATUS_WAIT || s === '') return 0;
              if (s === STATUS_DONE) return 2;
              return 1;
            };
            return rank(a[statusIdx]) - rank(b[statusIdx]);
          });
        }
        labelCounts[lineKey] = {
          total: rows.filter(r => labelIdx !== -1 && isIntLike(r[labelIdx])).length,
          done: rows.filter(r => statusIdx !== -1 && r[statusIdx].trim() === STATUS_DONE).length
        };
        lineData[lineKey] = { headers, rows, labelIdx, statusIdx };
        updateBadges(); updateReportSection(); renderLine(lineKey);
      } catch(e) {
        setTableContent(`<tr><td class="table-error" colspan="99">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>`);
      }
    }

    function renderLine(lineKey) {
      const data = lineData[lineKey]; if (!data) return;
      const { headers, rows, labelIdx, statusIdx } = data;
      const q = document.getElementById("tableSearch").value.trim().toLowerCase();
      const filtered = rows.filter(r => !q || (labelIdx !== -1 && r[labelIdx].toLowerCase().includes(q)));
      const colMatchers = [
        { label: '‚Ññ –º–µ—Ç–∫–∏', match: h => norm(h).includes('–º–µ—Ç–∫') },
        { label: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–æ–Ω—ã –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–∏–ø–∞', match: h => norm(h).includes('–Ω–∞–∏–º') && (norm(h).includes('–∑–æ–Ω') || norm(h).includes('—Ç–∏–ø')) },
        { label: '–û–ø–∏—Å–∞–Ω–∏–µ', match: h => norm(h).includes('–æ–ø–∏—Å') },
        { label: '–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞', match: h => norm(h) === norm(STATUS_COL_NAME) || norm(h).includes('—Å—Ç–∞—Ç') },
      ];
      const colIdxs = colMatchers.map(m => { const idx = headers.findIndex(m.match); return { label: m.label, idx }; }).filter(c => c.idx !== -1);
      const displayCols = colIdxs.length >= 2 ? colIdxs : headers.map((h, i) => ({ label: h || '‚Äî', idx: i }));
      document.getElementById("dataThead").innerHTML = `<tr>${displayCols.map(c => `<th>${esc(c.label)}</th>`).join('')}</tr>`;
      if (filtered.length === 0) {
        setTableContent(`<tr><td class="table-empty" colspan="${displayCols.length}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`);
      } else {
        document.getElementById("dataTbody").innerHTML = filtered.map(row => {
          const isDone = statusIdx !== -1 && row[statusIdx].trim() === STATUS_DONE;
          const isWait = statusIdx !== -1 && (row[statusIdx].trim() === STATUS_WAIT || row[statusIdx].trim() === '');
          return `<tr class="${isDone ? 'row-done' : (isWait ? 'row-wait' : '')}">${displayCols.map(c => `<td>${esc(row[c.idx] ?? '')}</td>`).join('')}</tr>`;
        }).join('');
      }
      const info = labelCounts[lineKey];
      document.getElementById("chipTotal").textContent = `–í—Å–µ–≥–æ: ${info.total}`;
      document.getElementById("chipDone").textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${info.done}`;
    }

    function setTableContent(html) { document.getElementById("dataTbody").innerHTML = html; document.getElementById("dataThead").innerHTML = ""; }

    async function loadStatusBox() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(STATUS_SHEET_NAME)}&range=${encodeURIComponent(STATUS_RANGE)}&headers=0&t=${Date.now()}`;
        const res = await fetch(url); const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const lines = json.table.rows.map(r => r.c.map(c => cellText(c?.v)).filter(Boolean).join(" ")).filter(Boolean);
        const box = document.getElementById("statusBox");
        if (lines.length) { document.getElementById("statusText").textContent = lines.join(" ¬∑ "); box.style.display = "flex"; }
        else box.style.display = "none";
      } catch { document.getElementById("statusBox").style.display = "none"; }
    }

    async function refreshData() {
      const btn = document.getElementById("refreshBtn");
      btn.disabled = true; btn.textContent = "‚åõ";
      (new Image()).src = `${TRIGGER_WEBAPP_URL}?token=${TRIGGER_TOKEN}&t=${Date.now()}`;
      lineData[currentLine] = null;
      setTimeout(async () => {
        await loadLine(currentLine, true); await loadStatusBox();
        btn.disabled = false; btn.textContent = "‚Ü∫ –û–±–Ω–æ–≤–∏—Ç—å";
      }, 3000);
    }

    function switchLine(lineKey) {
      currentLine = lineKey;
      document.querySelectorAll('.line-tab').forEach(t => t.classList.toggle('active', t.dataset.line === lineKey));
      document.getElementById("tableSearch").value = "";
      loadLine(lineKey); updateReportSection(); saveState();
    }

    function exportReport() {
      const name = document.getElementById('workerName').value || '–ö–æ–º–∞–Ω–¥–∞';
      const date = document.getElementById('workDate').value || new Date().toLocaleDateString('ru-RU');
      const info = labelCounts[currentLine];
      const lineLabel = currentLine === "kns" ? "–ö–ù–°" : currentLine === "2" ? "–õ–∏–Ω–∏—è 3" : currentLine === "night" ? "–ù–æ—á—å" : `–õ–∏–Ω–∏—è ${currentLine}`;
      const pct = info.total > 0 ? Math.round((info.done / info.total) * 100) : 0;
      let report = `@NURLAN_MURZABAEV @Ruslanburangulovv\nüìÖ ${date}\n–û—Ç—á—ë—Ç –ø–æ –æ–±—Ö–æ–¥—É:\n${name}\n–ú–∞—Ä—à—Ä—É—Ç: ${lineLabel}\n–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${info.done}/${info.total} –º–µ—Ç–æ–∫ (${pct}%)\n`;
      const countNew = parseInt(document.getElementById('countNew').textContent) || 0;
      const countLost = parseInt(document.getElementById('countLost').textContent) || 0;
      const notesNew = formatTagNumbers(document.getElementById('notesNew').value.trim());
      const notesLost = formatTagNumbers(document.getElementById('notesLost').value.trim());
      if (countNew > 0) { report += `\n–ù–æ–≤—ã–µ –º–µ—Ç–∫–∏: ${countNew} —à—Ç.`; if (notesNew) report += `\n–ù–æ–º–µ—Ä–∞: ${notesNew}`; report += `\n`; }
      if (countLost > 0) { report += `\n–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –º–µ—Ç–∫–∏: ${countLost} —à—Ç.`; if (notesLost) report += `\n–ù–æ–º–µ—Ä–∞: ${notesLost}`; report += `\n`; }
      openReportModal(report);
    }

    function openReportModal(text) {
      document.getElementById('reportTextarea').value = text;
      const modal = document.getElementById('reportModal');
      modal.classList.add('open');
      const btn = document.getElementById('btnCopy');
      btn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
      btn.classList.remove('copied');
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('open');
    }

    function copyReport() {
      const text = document.getElementById('reportTextarea').value;
      const btn = document.getElementById('btnCopy');
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
          btn.classList.remove('copied');
        }, 2500);
      }).catch(() => {
        document.getElementById('reportTextarea').select();
        document.execCommand('copy');
        btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        btn.classList.add('copied');
      });
    }

    document.getElementById('reportModal').addEventListener('click', function(e) {
      if (e.target === this) closeReportModal();
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeReportModal();
    });

    // =============================================
    //  –ö–ê–†–¢–ê BLE-–ú–ï–¢–û–ö
    // =============================================
    const BLE_API_BASE = 'https://raspy-sound-6f18.kejexu8hem1.workers.dev/proxy';
    const BLE_TOKEN_KEY = 'accessToken';
    const BLE_AUTO_USER = 'impl_dept';
    const BLE_AUTO_PASS = 'impl_dept_vsm_2024';
    let bleMap = null;
    let bleMapMarkers = [];
    let bleMapData = [];
    let bleMapFilter = 'all';
    let bleMapInitialized = false;
    let bleZoneData = []; // shared zone polygons

    function drawZones(targetMap) {
      if (!targetMap || !bleZoneData.length) return;
      bleZoneData.forEach(z => {
        L.polygon(z.pts, { color: z.color, opacity: 0.35, fillOpacity: 0.15, weight: 1.5 })
          .bindTooltip(z.name, { permanent: false, className: 'zone-label' })
          .addTo(targetMap);
      });
    }

    function getBleToken() { return localStorage.getItem(BLE_TOKEN_KEY); }

    function showMapMsg(text, type = '') {
      const el = document.getElementById('mapMsg');
      el.textContent = text;
      el.className = 'map-msg' + (type ? ' ' + type : '');
      el.style.display = 'block';
    }
    function hideMapMsg() { document.getElementById('mapMsg').style.display = 'none'; }

    async function bleApiFetch(path, retried = false) {
      let token = getBleToken();
      if (!token) {
        if (retried) throw new Error('auth_failed');
        await bleAutoLogin();
        return bleApiFetch(path, true);
      }
      const res = await fetch(BLE_API_BASE + path, {
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
      });
      if (res.status === 401 || res.status === 500) {
        if (retried) throw new Error(`HTTP ${res.status}`);
        localStorage.removeItem(BLE_TOKEN_KEY);
        await bleAutoLogin();
        return bleApiFetch(path, true);
      }
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function bleAutoLogin() {
      const res = await fetch(BLE_API_BASE + '/api/v1/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `username=${encodeURIComponent(BLE_AUTO_USER)}&password=${encodeURIComponent(BLE_AUTO_PASS)}`
      });
      if (!res.ok) throw new Error('auto_auth_failed');
      const data = await res.json();
      const token = data.accessToken || data.access_token || data.token;
      if (!token) throw new Error('no_token_in_response');
      localStorage.setItem(BLE_TOKEN_KEY, token);
      return token;
    }

    function initBleMap(center, zoom) {
      if (bleMap) return;
      const placeholder = document.getElementById('mapPlaceholder');
      if (placeholder) placeholder.remove();
      bleMap = L.map('bleMap', { attributionControl: false, zoomControl: true }).setView(center, zoom);

      const tileLayers = {
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
      };
      tileLayers.street.addTo(bleMap);
      let currentTileLayer = 'street';

      document.querySelectorAll('.map-layer-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const layer = btn.dataset.layer;
          if (layer === currentTileLayer) return;
          bleMap.removeLayer(tileLayers[currentTileLayer]);
          tileLayers[layer].addTo(bleMap);
          currentTileLayer = layer;
          document.querySelectorAll('.map-layer-btn').forEach(b => b.classList.toggle('active', b.dataset.layer === layer));
        });
      });

      setTimeout(() => bleMap.invalidateSize(), 200);
    }

    function classifyBle(point) {
      const LOW = 15;
      const inspectionDays = 1;
      const now = new Date();
      const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      let isInspected = false;
      let recordDt = '–ù–µ –æ–±—Ö–æ–¥–∏–ª–∞—Å—å';
      if (point.record_dt) {
        const d = new Date(point.record_dt);
        const inspDate = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
        isInspected = (today - inspDate) / 86400000 <= inspectionDays;
        recordDt = inspDate.toISOString().slice(0, 10);
      }
      const isLowBattery = point.charge_value != null && point.charge_value <= LOW;
      let status = 'ok';
      if (isLowBattery) status = 'battery';
      else if (!isInspected) status = 'inspection';
      return {
        id: point.id, ble: String(point.ble_number || ''),
        name: point.name_extended || '', lat: point.latitude, lng: point.longitude,
        charge: point.charge_value, locationDesc: point.location_desc || '',
        bleType: point.ble_type_desc || '', mac: point.mac_address || '',
        isInspected, isLowBattery, recordDt, status,
        photoTag: point.photo_url || point.tag_photo || point.ble_photo || '',
        photoPlace: point.place_photo_url || point.install_photo || point.location_photo || ''
      };
    }

    function createBleIcon(point) {
      const cls = `ble-dot ble-dot-${point.status}`;
      return L.divIcon({ className: '', html: `<div class="${cls}">${point.ble}</div>`, iconSize: [22, 22], iconAnchor: [11, 11] });
    }

    let bleClusterGroup = null;

    function makePopup(pt) {
      const photos = [pt.photoTag, pt.photoPlace].filter(Boolean);
      const photoHtml = photos.length
        ? `<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
            ${photos.map((url, i) => `
              <a href="${esc(url)}" target="_blank" style="display:block;flex:1;min-width:100px;">
                <img src="${esc(url)}"
                  style="width:100%;height:90px;object-fit:cover;border-radius:6px;display:block;border:1px solid #dde4ee;"
                  onerror="this.parentElement.style.display='none'">
              </a>`).join('')}
          </div>`
        : '';
      return `<div style="font-size:13px;line-height:1.5;min-width:160px;max-width:260px;">
        <div style="font-family:'Oswald',sans-serif;font-size:1em;font-weight:700;color:#0b2740;margin-bottom:2px;">
          –ú–µ—Ç–∫–∞ #${esc(pt.ble)}
        </div>
        <div style="color:#2a3a4a;margin-bottom:4px;">${esc(pt.name)}</div>
        ${pt.locationDesc ? `<div style="color:#5a6a7e;font-size:12px;">${esc(pt.locationDesc)}</div>` : ''}
        ${photoHtml}
      </div>`;
    }

    function makeClusterGroup() {
      return L.markerClusterGroup({
        // –¢—Ä–∏ —ç—Ç–∞–ø–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è:
        // zoom < 17  ‚Üí –∫—Ä—É–ø–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã (radius 120) ‚Äî –æ–¥–∏–Ω –∫—Ä—É–∂–æ–∫ –Ω–∞ —Ä–∞–π–æ–Ω
        // zoom 17-18 ‚Üí —Å—Ä–µ–¥–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä—ã (radius 40)  ‚Äî –≤–∏–¥–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–¥–∞–Ω–∏—è
        // zoom >= 19 ‚Üí –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞, –≤—Å–µ –º–µ—Ç–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
        maxClusterRadius: function(zoom) {
          if (zoom < 17) return 120;
          if (zoom < 18) return 40;
          return 1;
        },
        disableClusteringAtZoom: 18,
        spiderfyOnMaxZoom: false,
        showCoverageOnHover: false,
        animate: true,
        animateAddingMarkers: false,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          const size = count < 10 ? 'small' : count < 50 ? 'medium' : 'large';
          return L.divIcon({
            html: `<div><span>${count}</span></div>`,
            className: `marker-cluster marker-cluster-${size}`,
            iconSize: L.point(40, 40)
          });
        }
      });
    }

    function renderBleMarkers() {
      if (bleClusterGroup) { bleMap.removeLayer(bleClusterGroup); }
      bleClusterGroup = makeClusterGroup();
      const q = (document.getElementById('mapBleSearch').value || '').trim().toLowerCase();
      bleMapData.forEach(pt => {
        if (!pt.lat || !pt.lng) return;
        if (bleMapFilter !== 'all' && pt.status !== bleMapFilter) return;
        if (q && !pt.ble.toLowerCase().includes(q)) return;
        L.marker([pt.lat, pt.lng], { icon: createBleIcon(pt) })
          .bindPopup(makePopup(pt), { maxWidth: 280 })
          .addTo(bleClusterGroup);
      });
      bleMap.addLayer(bleClusterGroup);
      bleMapMarkers = []; // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    }

    function updateMapStats() {
      const all = bleMapData.length;
      const ok = bleMapData.filter(p => p.status === 'ok').length;
      const bat = bleMapData.filter(p => p.status === 'battery').length;
      const insp = bleMapData.filter(p => p.status === 'inspection').length;
      document.getElementById('fcAll').textContent = all;
      document.getElementById('fcOk').textContent = ok;
      document.getElementById('fcBat').textContent = bat;
      document.getElementById('fcInsp').textContent = insp;
    }

    async function loadBleMap() {
      try {
        let center = [53.038, 39.011];
        let zoom = 15;
        try {
          const cfg = await bleApiFetch('/api/v1/map/config');
          if (cfg.defaultView?.latitude) center = [cfg.defaultView.latitude, cfg.defaultView.longitude];
          if (cfg.defaultZoom) zoom = cfg.defaultZoom;
        } catch {}

        initBleMap(center, zoom);

        let companyId;
        try {
          const ud = await bleApiFetch('/api/v1/user/me/');
          companyId = ud.companyId || ud.company_id;
        } catch {
          try {
            const ud2 = await bleApiFetch('/api/v1/user/data');
            companyId = ud2.companyId || ud2.company_id;
          } catch {}
        }
        if (!companyId) { showMapMsg('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å companyId', 'error'); return; }

        const rawBle = await bleApiFetch(`/api/v1/map/ble/${companyId}`);
        bleMapData = rawBle.map(classifyBle);
        updateMapStats();
        renderBleMarkers();

        try {
          const mapData = await bleApiFetch(`/api/v1/map/${companyId}/map_data`);
          if (mapData.zones && mapData.points) {
            const pointsByZone = {};
            mapData.points.forEach(p => {
              if (!pointsByZone[p.zoneId]) pointsByZone[p.zoneId] = [];
              pointsByZone[p.zoneId].push([p.latitude, p.longitude]);
            });
            // Save zone data globally so fullscreen map can use it
            bleZoneData = mapData.zones.map(z => ({
              name: z.name || '',
              color: z.color || '#0088cc',
              pts: pointsByZone[z.id] || []
            })).filter(z => z.pts.length > 2);
            drawZones(bleMap);
          }
        } catch {}

        const validPts = bleMapData.filter(p => p.lat && p.lng);
        if (validPts.length > 1) {
          const bounds = L.latLngBounds(validPts.map(p => [p.lat, p.lng]));
          bleMap.fitBounds(bounds, { padding: [30, 30] });
        }

        document.getElementById('mapLayerToggle').style.display = 'flex';
        document.getElementById('mapFiltersBlock').style.display = 'flex';
        document.getElementById('mapSearchBlock').style.display = 'flex';
        document.getElementById('mapBottomControls').style.display = 'flex';
        document.getElementById('mapRetryBtn').style.display = 'none';
        hideMapMsg();
        bleMapInitialized = true;

      } catch (e) {
        localStorage.removeItem(BLE_TOKEN_KEY);
        showMapMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã: ' + e.message + '. –ù–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏.', 'error');
        document.getElementById('mapRetryBtn').style.display = 'inline-flex';
      }
    }

    async function retryBleMap() {
      const btn = document.getElementById('mapRetryBtn');
      btn.disabled = true;
      btn.textContent = '‚åõ –ó–∞–≥—Ä—É–∑–∫–∞...';
      localStorage.removeItem(BLE_TOKEN_KEY);
      bleMapInitialized = false;
      hideMapMsg();
      await loadBleMap();
      btn.disabled = false;
      btn.textContent = '‚Ü∫ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É';
    }

    document.querySelectorAll('.map-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.map-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bleMapFilter = btn.dataset.filter;
        renderBleMarkers();
      });
    });

    const mapBleSearchEl = document.getElementById('mapBleSearch');
    const mapSearchClearEl = document.getElementById('mapSearchClear');

    mapBleSearchEl?.addEventListener('input', () => {
      const raw = mapBleSearchEl.value;
      mapSearchClearEl.style.display = raw ? 'block' : 'none';
      renderBleMarkers();
      const q = raw.trim().toLowerCase().replace(/^ble/i, '');
      if (!q) return;
      const found = bleMapData.find(p => p.ble.toLowerCase() === q);
      if (found && found.lat && found.lng && bleClusterGroup) {
        bleClusterGroup.eachLayer(m => {
          if (m.getLatLng().lat === found.lat && m.getLatLng().lng === found.lng) {
            bleClusterGroup.zoomToShowLayer(m, () => m.openPopup());
          }
        });
      }
    });

    mapSearchClearEl?.addEventListener('click', () => {
      mapBleSearchEl.value = '';
      mapSearchClearEl.style.display = 'none';
      renderBleMarkers();
      mapBleSearchEl.focus();
    });

    const mapSection = document.querySelector('[data-map-section="ble"]');
    const mapSectionHeader = mapSection.querySelector('.map-section-header');
    mapSectionHeader.addEventListener('click', () => {
      const wasOpen = mapSection.classList.contains('open');
      mapSection.classList.toggle('open');
      if (!wasOpen && !bleMapInitialized) { loadBleMap(); }
      if (!wasOpen && bleMap) { setTimeout(() => bleMap.invalidateSize(), 300); }
      saveState();
    });

    // ‚îÄ‚îÄ REMINDERS SYSTEM ‚îÄ‚îÄ
    const SCHEDULE_SHEET_ID = '1h-GMxdT2z3MC-somIq8sX3iV6KfjaoCffIIfeBQezRk';
    const SCHEDULE_SHEET_NAME = '–≥—Ä–∞—Ñ–∏–∫ 2026';
    const MONTH_NAMES = ['—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å','–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'];

    async function fetchDayOff() {
      try {
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        const tMonth = MONTH_NAMES[tomorrow.getMonth()]; const tDay = tomorrow.getDate();
        const url = `https://docs.google.com/spreadsheets/d/${SCHEDULE_SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SCHEDULE_SHEET_NAME)}&range=E1:PZ50&headers=0&t=${Date.now()}`;
        const res = await fetch(url); const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        const monthRow = (rows[0]?.c || []).map(c => c ? String(c.v || '').trim().toLowerCase() : '');
        const dayRow = (rows[1]?.c || []).map(c => c ? String(c.v ?? '').trim() : '');
        let targetCol = -1, lastMonth = '';
        for (let i = 1; i < monthRow.length; i++) {
          if (monthRow[i]) lastMonth = monthRow[i];
          if (lastMonth === tMonth && dayRow[i] === String(tDay)) { targetCol = i; break; }
        }
        if (targetCol === -1) return [];
        const dayOffNames = [];
        for (let r = 2; r < rows.length; r++) {
          const cells = rows[r]?.c || [];
          const name = cells[0] ? String(cells[0].v || '').trim() : '';
          const value = cells[targetCol] ? String(cells[targetCol].v || '').trim().toUpperCase() : '';
          if (name && value === '–í–•') dayOffNames.push(name);
        }
        return dayOffNames;
      } catch (e) { return []; }
    }

    const SVG_ICONS = {
      package: '<svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4l-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
      truck: '<svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
      sync: '<svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
      building: '<svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="9" y1="6" x2="9" y2="6.01"/><line x1="15" y1="6" x2="15" y2="6.01"/><line x1="9" y1="10" x2="9" y2="10.01"/><line x1="15" y1="10" x2="15" y2="10.01"/><line x1="9" y1="14" x2="9" y2="14.01"/><line x1="15" y1="14" x2="15" y2="14.01"/><path d="M9 18h6"/></svg>',
      people: '<svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
    };

    const REMINDERS = [
      { id: 'ozon-cdek-prep', days: [0, 3], icon: SVG_ICONS.package, title: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', text: '–°–µ–≥–æ–¥–Ω—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤ OZON –¥–æ 13:00' },
      { id: 'ozon-cdek-place', days: [1, 4], icon: SVG_ICONS.truck, title: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', text: '–°–µ–≥–æ–¥–Ω—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑—ã –≤ OZON –¥–æ 13:00' },
      { id: 'sync-ww-dev', days: [2], icon: SVG_ICONS.sync, title: '–í—Å—Ç—Ä–µ—á–∞', text: '–°–µ–≥–æ–¥–Ω—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Å–∏–Ω–∫ ITS WW dev' },
      { id: 'meeting-deploy', days: [3], icon: SVG_ICONS.building, title: '–í—Å—Ç—Ä–µ—á–∞', text: '–°–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á–∞ –ø–ª–æ—â–∞–¥–æ–∫ –æ—Ç–¥–µ–ª–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è' },
      { id: 'meetup-friday', days: [5], icon: SVG_ICONS.people, title: 'Meet-up', text: '–°–µ–≥–æ–¥–Ω—è meet-up!' },
      { id: 'delete-test-shifts', monthly: { fromDay: 25 }, icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>', title: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', text: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–º–µ–Ω—ã' }
    ];

    async function checkReminders() {
      const container = document.getElementById('remindersContainer');
      const now = new Date();
      const dayOfWeek = now.getDay(); const dayOfMonth = now.getDate();
      const dismissed = JSON.parse(sessionStorage.getItem('dismissed_reminders_cl2') || '[]');
      const active = REMINDERS.filter(r => {
        if (dismissed.includes(r.id)) return false;
        if (r.days && r.days.includes(dayOfWeek)) return true;
        if (r.monthly && dayOfMonth >= r.monthly.fromDay) return true;
        return false;
      });
      let dayOffHtml = '';
      if (!dismissed.includes('day-off-tomorrow')) {
        const dayOffNames = await fetchDayOff();
        if (dayOffNames.length > 0) {
          const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
          const dateStr = tomorrow.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
          dayOffHtml = `<div class="reminder-banner" data-reminder-id="day-off-tomorrow"><span class="reminder-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><div class="reminder-content"><span class="reminder-title">–í—ã—Ö–æ–¥–Ω—ã–µ –∑–∞–≤—Ç—Ä–∞ (${dateStr})</span><span class="reminder-text">${dayOffNames.join(', ')}</span></div><button class="reminder-close" onclick="dismissReminder('day-off-tomorrow')" title="–°–∫—Ä—ã—Ç—å">‚úï</button></div>`;
        }
      }
      if (active.length === 0 && !dayOffHtml) { container.style.display = 'none'; return; }
      container.style.display = 'flex';
      container.innerHTML = dayOffHtml + active.map(r => `<div class="reminder-banner" data-reminder-id="${r.id}"><span class="reminder-icon">${r.icon}</span><div class="reminder-content"><span class="reminder-title">${r.title}</span><span class="reminder-text">${r.text}</span></div><button class="reminder-close" onclick="dismissReminder('${r.id}')" title="–°–∫—Ä—ã—Ç—å">‚úï</button></div>`).join('');
    }

    function dismissReminder(id) {
      const dismissed = JSON.parse(sessionStorage.getItem('dismissed_reminders_cl2') || '[]');
      dismissed.push(id); sessionStorage.setItem('dismissed_reminders_cl2', JSON.stringify(dismissed));
      const banner = document.querySelector(`[data-reminder-id="${id}"]`);
      if (banner) banner.classList.add('hidden');
      const container = document.getElementById('remindersContainer');
      if (!container.querySelector('.reminder-banner:not(.hidden)')) container.style.display = 'none';
    }


    // =============================================
    //  FULLSCREEN MAP
    // =============================================
    let bleMapFS = null;
    let bleMapFSMarkers = [];
    let bleMapFSFilter = 'all';
    let bleMapFSInitialized = false;
    let fsTileLayers = null;
    let fsTileLayerCurrent = 'street';

    function syncFsStats() {
      const all = bleMapData.length;
      const ok = bleMapData.filter(p => p.status === 'ok').length;
      const bat = bleMapData.filter(p => p.status === 'battery').length;
      const insp = bleMapData.filter(p => p.status === 'inspection').length;
      const el = id => document.getElementById(id);
      if (el('fcFsAll')) el('fcFsAll').textContent = all;
      if (el('fcFsOk')) el('fcFsOk').textContent = ok;
      if (el('fcFsBat')) el('fcFsBat').textContent = bat;
      if (el('fcFsInsp')) el('fcFsInsp').textContent = insp;
    }

    let bleClusterGroupFS = null;

    function renderFsMarkers() {
      if (!bleMapFS) return;
      if (bleClusterGroupFS) { bleMapFS.removeLayer(bleClusterGroupFS); }
      bleClusterGroupFS = makeClusterGroup();
      const q = (document.getElementById('mapFsSearch').value || '').trim().toLowerCase().replace(/^ble/i,'');
      bleMapData.forEach(pt => {
        if (!pt.lat || !pt.lng) return;
        if (bleMapFSFilter !== 'all' && pt.status !== bleMapFSFilter) return;
        if (q && !pt.ble.toLowerCase().includes(q)) return;
        L.marker([pt.lat, pt.lng], { icon: createBleIcon(pt) })
          .bindPopup(makePopup(pt), { maxWidth: 280 })
          .addTo(bleClusterGroupFS);
      });
      bleMapFS.addLayer(bleClusterGroupFS);
      bleMapFSMarkers = [];
    }

    function openFullscreenMap() {
      const overlay = document.getElementById('mapFullscreenOverlay');
      overlay.classList.add('open');
      document.body.style.overflow = 'hidden';

      if (!bleMapFSInitialized) {
        // Init map in the fullscreen container
        const fsEl = document.getElementById('bleMapFS');
        bleMapFS = L.map('bleMapFS', { attributionControl: false, zoomControl: true });

        fsTileLayers = {
          satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
          street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        };
        fsTileLayers.street.addTo(bleMapFS);

        // Copy view from main map or fit bounds
        if (bleMap) {
          bleMapFS.setView(bleMap.getCenter(), bleMap.getZoom());
        } else if (bleMapData.length) {
          const validPts = bleMapData.filter(p => p.lat && p.lng);
          if (validPts.length > 1) {
            bleMapFS.fitBounds(L.latLngBounds(validPts.map(p => [p.lat, p.lng])), { padding: [30, 30] });
          } else {
            bleMapFS.setView([53.038, 39.011], 15);
          }
        } else {
          bleMapFS.setView([53.038, 39.011], 15);
        }

        // Layer toggle
        document.querySelectorAll('[data-fslayer]').forEach(btn => {
          btn.addEventListener('click', () => {
            const layer = btn.dataset.fslayer;
            if (layer === fsTileLayerCurrent) return;
            bleMapFS.removeLayer(fsTileLayers[fsTileLayerCurrent]);
            fsTileLayers[layer].addTo(bleMapFS);
            fsTileLayerCurrent = layer;
            document.querySelectorAll('[data-fslayer]').forEach(b => b.classList.toggle('active', b.dataset.fslayer === layer));
          });
        });

        // Filter buttons
        document.querySelectorAll('[data-fsfilter]').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('[data-fsfilter]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            bleMapFSFilter = btn.dataset.fsfilter;
            renderFsMarkers();
          });
        });

        // Search
        const fsSearchEl = document.getElementById('mapFsSearch');
        const fsSearchClear = document.getElementById('mapFsSearchClear');
        fsSearchEl.addEventListener('input', () => {
          fsSearchClear.style.display = fsSearchEl.value ? 'block' : 'none';
          renderFsMarkers();
          const q = fsSearchEl.value.trim().toLowerCase().replace(/^ble/i,'');
          if (!q) return;
          const found = bleMapData.find(p => p.ble.toLowerCase() === q);
          if (found && found.lat && found.lng && bleClusterGroupFS) {
            bleClusterGroupFS.eachLayer(m => {
              if (m.getLatLng().lat === found.lat && m.getLatLng().lng === found.lng) {
                bleClusterGroupFS.zoomToShowLayer(m, () => m.openPopup());
              }
            });
          }
        });
        fsSearchClear.addEventListener('click', () => {
          fsSearchEl.value = ''; fsSearchClear.style.display = 'none';
          renderFsMarkers(); fsSearchEl.focus();
        });

        drawZones(bleMapFS);
        bleMapFSInitialized = true;
      }

      syncFsStats();
      renderFsMarkers();
      setTimeout(() => bleMapFS.invalidateSize(), 150);
    }

    function closeFullscreenMap() {
      document.getElementById('mapFullscreenOverlay').classList.remove('open');
      document.body.style.overflow = '';
    }

    // Close on Escape
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && document.getElementById('mapFullscreenOverlay').classList.contains('open')) {
        closeFullscreenMap();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('workDate').valueAsDate = new Date();
      const logo = document.querySelector('header img');
      if (logo) logo.addEventListener('error', () => {
        logo.style.display = 'none';
        document.getElementById('logoFallback').style.display = 'inline';
      });
      checkReminders();
      loadState();

      document.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', () => { header.parentElement.classList.toggle('open'); saveState(); });
      });
      document.querySelectorAll('.subtask').forEach(subtask => {
        subtask.addEventListener('click', function(e) {
          const checkbox = this.querySelector('input[type="checkbox"]');
          if (e.target !== checkbox && checkbox) { checkbox.checked = !checkbox.checked; this.classList.toggle('completed', checkbox.checked); }
          saveState(); updateAllProgress();
        });
      });
      const tableGroupHeader = document.querySelector('.table-group-header');
      const tableGroup = document.querySelector('[data-tgroup="lines"]');
      tableGroupHeader.addEventListener('click', () => {
        const wasOpen = tableGroup.classList.contains('open');
        tableGroup.classList.toggle('open');
        if (!wasOpen) { ["1","2","kns","night"].forEach(k => { if (!lineData[k]) loadLine(k); }); loadStatusBox(); }
        saveState();
      });
      document.querySelectorAll('.line-tab').forEach(tab => { tab.addEventListener('click', () => switchLine(tab.dataset.line)); });
      document.getElementById('notesNew').addEventListener('input', saveState);
      document.getElementById('notesLost').addEventListener('input', saveState);
      if (document.querySelector('[data-tgroup="lines"]').classList.contains('open')) {
        ["1","2","kns","night"].forEach(k => loadLine(k)); loadStatusBox();
      }
      document.getElementById('workDate').addEventListener('change', saveState);
      document.getElementById('workerName').addEventListener('input', saveState);
      document.getElementById('tableSearch').addEventListener('input', () => renderLine(currentLine));

      if (mapSection.classList.contains('open') && !bleMapInitialized) { loadBleMap(); }
    });

    window.addEventListener('beforeunload', saveState);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) saveState(); });
  </script>

  <!-- FULLSCREEN MAP -->
  <div class="map-fullscreen-overlay" id="mapFullscreenOverlay">
    <div class="map-fullscreen-header">
      <span class="map-fullscreen-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00b0ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        –ö–∞—Ä—Ç–∞ BLE-–º–µ—Ç–æ–∫
      </span>
      <button class="map-fullscreen-close" onclick="closeFullscreenMap()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="map-fullscreen-controls" id="mapFsFilters">
      <button class="map-filter-btn filter-all active" data-fsfilter="all">–í—Å–µ <span class="filter-count" id="fcFsAll">0</span></button>
      <button class="map-filter-btn filter-ok" data-fsfilter="ok">‚úì –í –Ω–æ—Ä–º–µ <span class="filter-count" id="fcFsOk">0</span></button>
      <button class="map-filter-btn filter-battery" data-fsfilter="battery">–ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ <span class="filter-count" id="fcFsBat">0</span></button>
      <button class="map-filter-btn filter-inspection" data-fsfilter="inspection">–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ <span class="filter-count" id="fcFsInsp">0</span></button>
    </div>
    <div class="map-fullscreen-search">
      <input type="text" id="mapFsSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ –º–µ—Ç–∫–∏: 898 –∏–ª–∏ ble898" inputmode="numeric">
      <button class="map-fullscreen-search-clear" id="mapFsSearchClear" title="–û—á–∏—Å—Ç–∏—Ç—å">‚úï</button>
    </div>
    <div class="map-fullscreen-layer">
      <button class="map-layer-btn" id="btnFsSatellite" data-fslayer="satellite">üõ∞ –°–ø—É—Ç–Ω–∏–∫</button>
      <button class="map-layer-btn active" id="btnFsStreet" data-fslayer="street">üó∫ –°—Ö–µ–º–∞</button>
    </div>
    <div id="bleMapFS"></div>
  </div>
</body>
</html>
